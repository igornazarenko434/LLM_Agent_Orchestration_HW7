# Implementation Plan: M6.1 CLI Argument Parsing & M6.2 Operational Scripts
## **PRODUCTION-GRADE VERSION WITH FULL ACCESSIBILITY & USABILITY COMPLIANCE**

**Date:** 2025-12-27
**Version:** 2.0 (Enhanced)
**Status:** READY FOR IMPLEMENTATION
**Missions:** M6.1 (CLI Argument Parsing), M6.2 (Operational Scripts), M6.6 (Usability Analysis)
**Estimated Time:** 5 hours total (was 3.5 hours)
**Compliance:** Nielsen's Heuristics, WCAG 2.1 Accessibility, Production CLI Best Practices

---

## TABLE OF CONTENTS

1. [Overview](#overview)
2. [System Context & Consistency](#system-context--consistency)
3. [Phase 1: CLI Argument Parsing (M6.1)](#phase-1-cli-argument-parsing-m61)
4. [Phase 1.5: CLI Best Practices Enhancement](#phase-15-cli-best-practices-enhancement)
5. [Phase 2: Core Operational Scripts (M6.2)](#phase-2-core-operational-scripts-m62)
6. [Phase 3: Verification Stage Scripts](#phase-3-verification-stage-scripts)
7. [Phase 4: Testing & Validation](#phase-4-testing--validation)
8. [Phase 5: Documentation Update](#phase-5-documentation-update)
9. [Phase 5.5: Usability Analysis (M6.6)](#phase-55-usability-analysis-m66)
10. [Success Criteria](#success-criteria)
11. [Rollback Plan](#rollback-plan)

---

## OVERVIEW

### Goals

1. **M6.1:** Add consistent argparse-based CLI argument parsing to all 4 player agents (P01-P04)
2. **M6.2:** Create missing operational scripts (backup/restore + verification helpers)
3. **M6.6:** Ensure full accessibility, usability, and production-grade CLI design
4. **Integration:** Ensure all scripts align with the 14-step system integration verification plan
5. **UX:** Make system intuitive, accessible, and easy to debug during all stages

### Principles

- **Consistency:** All agents use same CLI patterns and error codes
- **Accessibility:** Screen reader compatible (--plain mode, no emoji-only information)
- **Operational Focus:** Scripts map directly to verification stages (0-14) and actual error codes (E001-E018)
- **Error Handling:** All scripts use actual error codes with recovery suggestions
- **Documentation:** Self-documenting via --help, with examples and exit codes

---

## SYSTEM CONTEXT & CONSISTENCY

### Actual Implementation Reference

**18 Message Types (from protocol.py):**
1. REFEREE_REGISTER_REQUEST
2. REFEREE_REGISTER_RESPONSE
3. LEAGUE_REGISTER_REQUEST
4. LEAGUE_REGISTER_RESPONSE
5. ROUND_ANNOUNCEMENT
6. LEAGUE_STANDINGS_UPDATE
7. ROUND_COMPLETED
8. LEAGUE_COMPLETED
9. GAME_INVITATION
10. GAME_JOIN_ACK
11. CHOOSE_PARITY_CALL
12. CHOOSE_PARITY_RESPONSE
13. GAME_OVER
14. MATCH_RESULT_REPORT
15. LEAGUE_QUERY
16. LEAGUE_QUERY_RESPONSE
17. LEAGUE_ERROR
18. GAME_ERROR

**18 Error Codes (from protocol.py ErrorCode class):**
- **E001:** TIMEOUT_ERROR (retryable)
- **E002:** INVALID_MESSAGE_FORMAT
- **E003:** AUTHENTICATION_FAILED
- **E004:** AGENT_NOT_REGISTERED
- **E005:** INVALID_GAME_STATE (retryable)
- **E006:** PLAYER_NOT_AVAILABLE (retryable)
- **E007:** MATCH_NOT_FOUND
- **E008:** LEAGUE_NOT_FOUND
- **E009:** ROUND_NOT_ACTIVE (retryable)
- **E010:** INVALID_MOVE
- **E011:** PROTOCOL_VERSION_MISMATCH
- **E012:** AUTH_TOKEN_INVALID
- **E013:** CONVERSATION_ID_MISMATCH
- **E014:** RATE_LIMIT_EXCEEDED (retryable)
- **E015:** INTERNAL_SERVER_ERROR (retryable)
- **E016:** SERVICE_UNAVAILABLE (retryable)
- **E017:** DUPLICATE_REGISTRATION
- **E018:** INVALID_ENDPOINT

**Retryable Errors:** E001, E005, E006, E009, E014, E015, E016

**14-Step Verification Flow:**
- **Step 0:** Preconditions (config validation)
- **Steps 1-3:** Agent startup and registration (LM ‚Üí REF ‚Üí Players)
- **Step 4:** League orchestration trigger
- **Steps 5-7:** Match execution, standings, round completion
- **Step 8:** League completion and cleanup
- **Steps 9-14:** Manual tools, auth checks, log analysis

**Agents:**
- **League Manager:** LM01 (port 8000)
- **Referees:** REF01 (port 8001), REF02 (port 8002)
- **Players:** P01 (port 8101), P02 (port 8102), P03 (port 8103), P04 (port 8104)

**MCP Tools (Actual):**
- **League Manager:** start_league, get_standings, league_query, register_referee, register_player
- **Referees:** get_match_state, get_registration_status, manual_register
- **Players:** get_player_state, get_registration_status, manual_register

---

## PHASE 1: CLI ARGUMENT PARSING (M6.1)

**Estimated Time:** 1.5 hours
**Priority:** P0 (Blocks M9.0 deployment)

### Task 1.1: Add argparse to Player P01

**File:** `agents/player_P01/main.py`

**Changes:**
1. Add `parse_args()` function with production-grade help text
2. Replace environment variable reads with `args.*` values
3. Keep backward compatibility: CLI args > Env vars > Config > Defaults

**Implementation:**

```python
import argparse
import os
import sys
from pathlib import Path

def parse_args():
    """
    Parse command-line arguments for Player P01.

    Priority Order:
        1. CLI arguments (highest priority)
        2. Environment variables
        3. Config file values
        4. Hardcoded defaults (lowest priority)
    """
    # Load configs for defaults
    system_config = load_system_config("SHARED/config/system.json")
    agents_config = load_agents_config("SHARED/config/agents/agents_config.json")
    default_league_id = _default_league_id()

    player_record = next(
        (p for p in agents_config.get("players", []) if p.get("agent_id") == "P01"),
        {},
    )

    parser = argparse.ArgumentParser(
        prog="player_P01",
        description="Player Agent P01 for Even/Odd League Multi-Agent System",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Start with defaults from config
  python -m agents.player_P01.main

  # Override player ID and port
  python -m agents.player_P01.main --player-id P05 --port 8105

  # Enable debug logging
  python -m agents.player_P01.main --log-level DEBUG

  # Plain output for screen readers (no emojis)
  python -m agents.player_P01.main --plain

  # Verbose mode for troubleshooting
  python -m agents.player_P01.main --verbose

  # JSON output for automation/CI
  python -m agents.player_P01.main --json

Environment Variables:
  AGENT_ID        Override player ID (CLI takes precedence)
  LEAGUE_ID       Override league ID
  BASE_HOST       Override bind host
  PLAYER_PORT     Override bind port
  LOG_LEVEL       Override log level (DEBUG|INFO|WARNING|ERROR)

Exit Codes:
  0   Success - agent running
  1   Configuration error (E002, E008, E011)
  2   Network error (E016, E018)
  3   Registration error (E004, E012, E017)
  4   Runtime error (E015)

Error Codes:
  E001-E018 - See doc/error_codes_reference.md
  Retryable: E001, E005, E006, E009, E014, E015, E016
  Non-retryable: E002, E003, E004, E007, E008, E010, E011, E012, E013, E017, E018

Documentation:
  README: README.md
  API Reference: doc/api_reference.md
  Troubleshooting: doc/troubleshooting.md
  Error Codes: doc/error_codes_reference.md
  System Integration: doc/system_integration_verification_plan.md
        """,
    )

    # Required arguments (with fallbacks)
    parser.add_argument(
        "--player-id",
        type=str,
        default=os.getenv("AGENT_ID") or player_record.get("agent_id", "P01"),
        metavar="ID",
        help="Player ID (default: P01 from config or env AGENT_ID)",
    )

    parser.add_argument(
        "--league-id",
        type=str,
        default=os.getenv("LEAGUE_ID") or default_league_id,
        required=default_league_id is None,
        metavar="ID",
        help="League ID (default: auto-detected from SHARED/config/leagues/)",
    )

    # Network arguments
    parser.add_argument(
        "--host",
        type=str,
        default=os.getenv("BASE_HOST") or system_config.network.host,
        metavar="HOST",
        help="Host to bind to (default: 0.0.0.0 from config or env BASE_HOST)",
    )

    parser.add_argument(
        "--port",
        type=int,
        default=int(
            os.getenv("PLAYER_PORT", player_record.get("port", system_config.network.player_port_start))
        ),
        metavar="PORT",
        help="Port to bind to (default: 8101 from config or env PLAYER_PORT). Must be 1024-65535.",
    )

    # Logging arguments
    parser.add_argument(
        "--log-level",
        type=str,
        default=os.getenv("LOG_LEVEL") or system_config.logging.get("level", "INFO"),
        choices=["DEBUG", "INFO", "WARNING", "ERROR"],
        metavar="LEVEL",
        help="Log level (default: INFO from config or env LOG_LEVEL)",
    )

    # Output control arguments (NEW - Phase 1.5)
    parser.add_argument(
        "--verbose", "-v",
        action="store_true",
        help="Enable verbose output (show all registration attempts, debug details)",
    )

    parser.add_argument(
        "--quiet", "-q",
        action="store_true",
        help="Minimal output (errors only, for CI/CD pipelines)",
    )

    parser.add_argument(
        "--plain",
        action="store_true",
        help="Plain text output (no emojis, for screen readers and accessibility)",
    )

    parser.add_argument(
        "--json",
        action="store_true",
        help="Output status as JSON (for automation and programmatic parsing)",
    )

    # Config override (NEW - Phase 1.5)
    parser.add_argument(
        "--config",
        type=str,
        metavar="PATH",
        help="Path to custom config directory (default: SHARED/config)",
    )

    # Version
    parser.add_argument(
        "--version",
        action="version",
        version="Player Agent P01 1.0.0 (league.v2 protocol)",
    )

    args = parser.parse_args()

    # Validation
    if args.verbose and args.quiet:
        parser.error("--verbose and --quiet are mutually exclusive")

    if args.json and (args.verbose or args.plain):
        parser.error("--json cannot be combined with --verbose or --plain")

    if not (1024 <= args.port <= 65535):
        parser.error(f"Port must be between 1024-65535, got: {args.port}")

    return args


async def main() -> None:
    """Main entry point with enhanced CLI support."""
    args = parse_args()

    # Set up logging based on args
    if args.verbose:
        log_level = "DEBUG"
    elif args.quiet:
        log_level = "ERROR"
    else:
        log_level = args.log_level

    # Load configs (with custom config path if provided)
    config_base = args.config if args.config else "SHARED/config"
    system_config = load_system_config(f"{config_base}/system.json")
    # ... rest of config loading

    # Use args values
    agent_id = args.player_id
    league_id = args.league_id
    host = args.host
    port = args.port

    # Create agent
    agent = PlayerAgent(
        agent_id=agent_id,
        league_id=league_id,
        host=host,
        port=port,
        plain_output=args.plain,  # NEW: accessibility mode
    )

    # Start agent
    agent.start(run_in_thread=True)

    # Output based on mode
    if args.json:
        import json
        print(json.dumps({
            "status": "running",
            "agent_id": agent_id,
            "league_id": league_id,
            "host": host,
            "port": port,
            "endpoints": {
                "health": f"http://{host}:{port}/health",
                "mcp": f"http://{host}:{port}/mcp"
            }
        }))
    elif not args.quiet:
        if args.plain:
            print(f"[INFO] Player {agent_id} running on {host}:{port}")
            print(f"[INFO] Health endpoint: http://{host}:{port}/health")
            print(f"[INFO] MCP endpoint: http://{host}:{port}/mcp")
            print(f"[INFO] Press Ctrl+C to stop")
        else:
            print(f"üéÆ Player {agent_id} running on {host}:{port}")
            print(f"   Health: http://{host}:{port}/health")
            print(f"   MCP: http://{host}:{port}/mcp")
            print("Press Ctrl+C to stop")

    # ... rest of main() (registration, shutdown, etc.)
```

**Self-Verify Command:**
```bash
python -m agents.player_P01.main --help | grep -E "usage:|--player-id|--league-id|--port|--verbose|--plain|--json"
python -m agents.player_P01.main --version
python -m agents.player_P01.main --invalid-arg 2>&1 | grep "error: unrecognized arguments"
```

**Expected Output:**
```
usage: player_P01 [-h] [--player-id ID] [--league-id ID] [--host HOST] [--port PORT]
                  [--log-level LEVEL] [--verbose] [--quiet] [--plain] [--json]
                  [--config PATH] [--version]
...
Player Agent P01 1.0.0 (league.v2 protocol)
error: unrecognized arguments: --invalid-arg
```

---

### Task 1.2-1.4: Add argparse to Players P02, P03, P04

**Files:**
- `agents/player_P02/main.py`
- `agents/player_P03/main.py`
- `agents/player_P04/main.py`

**Changes:** Same as Task 1.1, but with:
- **P02:** Default `--player-id`: P02, version: "Player Agent P02 1.0.0", port: 8102
- **P03:** Default `--player-id`: P03, version: "Player Agent P03 1.0.0", port: 8103
- **P04:** Default `--player-id`: P04, version: "Player Agent P04 1.0.0", port: 8104

---

## PHASE 1.5: CLI BEST PRACTICES ENHANCEMENT

**Estimated Time:** 1.5 hours (NEW)
**Priority:** P1 (M6.6 compliance)

### Task 1.5.1: Create Error Codes Reference Document

**File:** `doc/error_codes_reference.md`

**Purpose:** Complete reference for all 18 error codes with recovery suggestions

**Implementation:**

```markdown
# Error Codes Reference - Even/Odd League System

**Protocol:** league.v2
**Total Error Codes:** 18 (E001-E018)
**Retryable Errors:** 7 (E001, E005, E006, E009, E014, E015, E016)
**Non-Retryable Errors:** 11

---

## Error Code Categories

### Configuration Errors (E002, E008, E011)
### Authentication Errors (E003, E004, E012, E017, E018)
### Game State Errors (E005, E007, E009, E010, E013)
### Network/System Errors (E001, E006, E014, E015, E016)

---

## E001: TIMEOUT_ERROR
**Category:** Network/System
**Severity:** Warning
**Retryable:** Yes
**Typical Causes:**
- Agent not responding within timeout window
- Network latency/packet loss
- Agent overloaded (too many concurrent requests)

**Suggested Actions:**
1. Check agent health: `./scripts/check_health.sh`
2. Check network connectivity: `ping localhost`
3. Increase timeout in `SHARED/config/system.json` (timeouts section)
4. Check agent logs for performance issues: `./scripts/analyze_logs.sh GAME_ERROR`

**Configuration:**
```json
// SHARED/config/system.json
"timeouts": {
  "game_join_ack_sec": 5,      // Join timeout (default: 5s)
  "parity_choice_sec": 30,      // Choice timeout (default: 30s)
  "registration_sec": 10        // Registration timeout (default: 10s)
}
```

**Related Errors:** E006 (PLAYER_NOT_AVAILABLE), E016 (SERVICE_UNAVAILABLE)
**Documentation:** doc/system_integration_verification_plan.md#5-match-execution

---

## E002: INVALID_MESSAGE_FORMAT
**Category:** Configuration
**Severity:** Error
**Retryable:** No
**Exit Code:** 1

**Typical Causes:**
- Malformed JSON in message
- Missing required fields (protocol, message_type, sender, timestamp, conversation_id)
- Invalid field types (e.g., string instead of int for round_id)
- Invalid sender format (must be "{agent_type}:{agent_id}")

**Suggested Actions:**
1. Validate message structure against protocol: `python3 -c "from league_sdk.protocol import MessageEnvelope; ..."`
2. Check sender format: Must match `^(player|referee|league_manager):[A-Z0-9]+$`
3. Check timestamp format: Must be ISO 8601 UTC (`YYYY-MM-DDTHH:MM:SSZ`)
4. Verify all required fields present

**Example Valid Message:**
```json
{
  "protocol": "league.v2",
  "message_type": "GAME_JOIN_ACK",
  "sender": "player:P01",
  "timestamp": "2025-01-15T12:30:45Z",
  "conversation_id": "conv-match-M001",
  "auth_token": "token_abc123...",
  "payload": {"status": "JOINED"}
}
```

**Related Errors:** E011 (PROTOCOL_VERSION_MISMATCH)
**Documentation:** SHARED/league_sdk/protocol.py (MessageEnvelope class)

---

## E003: AUTHENTICATION_FAILED
**Category:** Authentication
**Severity:** Error
**Retryable:** No
**Exit Code:** 3

**Typical Causes:**
- Invalid credentials during registration
- Tampered auth_token
- Token expired (if token expiration is implemented)

**Suggested Actions:**
1. Re-register agent: Use `manual_register` MCP tool
2. Check League Manager logs for authentication failures
3. Verify `require_auth` setting in `SHARED/config/system.json`
4. Check if agent was previously de-registered

**Related Errors:** E012 (AUTH_TOKEN_INVALID), E004 (AGENT_NOT_REGISTERED)
**Documentation:** doc/system_integration_verification_plan.md#10-auth-token-verification

---

## E004: AGENT_NOT_REGISTERED
**Category:** Authentication
**Severity:** Error
**Retryable:** No
**Exit Code:** 3

**Typical Causes:**
- Agent never registered with League Manager
- Agent was de-registered
- Registration failed but agent continued running

**Suggested Actions:**
1. Check registration status: `./scripts/check_registration_status.sh`
2. Register manually: Use `manual_register` MCP tool via agent's /mcp endpoint
3. Check League Manager logs: `./scripts/analyze_logs.sh MESSAGE_RECEIVED`
4. Verify League Manager is running: `./scripts/check_health.sh`
5. Restart agent with auto-register enabled: Check `metadata.auto_register` in agents_config.json

**Prevention:**
```json
// SHARED/config/agents/agents_config.json
"players": [
  {
    "agent_id": "P01",
    "metadata": {
      "auto_register": true  // Enable auto-registration on startup
    }
  }
]
```

**Related Errors:** E017 (DUPLICATE_REGISTRATION), E003 (AUTHENTICATION_FAILED)
**Documentation:** doc/system_integration_verification_plan.md#2-launch-referees

---

## E005: INVALID_GAME_STATE
**Category:** Game State
**Severity:** Warning
**Retryable:** Yes

**Typical Causes:**
- Received move/choice in wrong game phase
- Match already finished but agent sent late response
- Race condition between agents

**Suggested Actions:**
1. Check match state: `./scripts/view_match_state.sh <match_id> <referee_port>`
2. Review match lifecycle in logs: `./scripts/analyze_logs.sh MATCH_ASSIGNED`
3. System will retry automatically (retryable error)

**Match Lifecycle States:**
- WAITING_FOR_PLAYERS
- COLLECTING_CHOICES
- DRAWING_NUMBER
- FINISHED
- FAILED

**Related Errors:** E007 (MATCH_NOT_FOUND), E009 (ROUND_NOT_ACTIVE)
**Documentation:** agents/referee_REF01/match_conductor.py (MatchConductor class)

---

## E006: PLAYER_NOT_AVAILABLE
**Category:** Network/System
**Severity:** Warning
**Retryable:** Yes

**Typical Causes:**
- Player agent crashed or stopped
- Network connection lost
- Player endpoint unreachable
- Player overloaded/not responding

**Suggested Actions:**
1. Check player health: `curl http://localhost:8101/health` (replace port)
2. Check if player process running: `ps aux | grep player_P01`
3. Check player logs: `cat SHARED/logs/player_P01*.log.jsonl`
4. Restart player: `python -m agents.player_P01.main`
5. System will retry automatically (retryable error)

**Related Errors:** E001 (TIMEOUT_ERROR), E016 (SERVICE_UNAVAILABLE)
**Documentation:** doc/system_integration_verification_plan.md#13-common-failure-points

---

## E007: MATCH_NOT_FOUND
**Category:** Game State
**Severity:** Error
**Retryable:** No

**Typical Causes:**
- Invalid match_id in request
- Match data not persisted (referee issue)
- Wrong referee queried (match conducted by different referee)

**Suggested Actions:**
1. Verify match_id from round announcement logs
2. Check match repository: `ls SHARED/data/matches/`
3. Query correct referee (REF01 vs REF02)
4. Check rounds.json for match assignments: `cat SHARED/data/leagues/<league_id>/rounds.json`

**Related Errors:** E005 (INVALID_GAME_STATE)
**Documentation:** SHARED/league_sdk/repositories.py (MatchRepository class)

---

## E008: LEAGUE_NOT_FOUND
**Category:** Configuration
**Severity:** Error
**Retryable:** No
**Exit Code:** 1

**Typical Causes:**
- Invalid league_id
- League config file missing
- Typo in league_id argument

**Suggested Actions:**
1. List available leagues: `ls SHARED/config/leagues/`
2. Check league config exists: `cat SHARED/config/leagues/<league_id>.json`
3. Verify league_id spelling
4. Create league config if missing: Follow template in doc/configuration.md

**Example:**
```bash
# List leagues
ls SHARED/config/leagues/
# Output: league_2025_even_odd.json

# Use correct league_id
python -m agents.league_manager.main --league-id league_2025_even_odd
```

**Related Errors:** E002 (INVALID_MESSAGE_FORMAT)
**Documentation:** doc/configuration.md#league-configuration

---

## E009: ROUND_NOT_ACTIVE
**Category:** Game State
**Severity:** Warning
**Retryable:** Yes

**Typical Causes:**
- Round not started yet
- Round already completed
- League not started (still in INIT state)

**Suggested Actions:**
1. Check league state: `./scripts/query_standings.sh`
2. Trigger league start: `./scripts/trigger_league_start.sh`
3. Check round status: `cat SHARED/data/leagues/<league_id>/rounds.json | jq '.rounds[] | {round_id, status}'`
4. System will retry automatically (retryable error)

**Round Status Values:**
- PENDING
- ACTIVE
- COMPLETED

**Related Errors:** E005 (INVALID_GAME_STATE), E009 (ROUND_NOT_ACTIVE)
**Documentation:** doc/system_integration_verification_plan.md#4-start-league-orchestration

---

## E010: INVALID_MOVE
**Category:** Game State
**Severity:** Error
**Retryable:** No

**Typical Causes:**
- Invalid parity choice (not "even" or "odd")
- Invalid number (not 1-10)
- Malformed payload

**Suggested Actions:**
1. Validate parity choice: Must be exactly "even" or "odd" (lowercase)
2. Validate number: Must be integer 1-10 inclusive
3. Check player implementation for correct payload format

**Valid CHOOSE_PARITY_RESPONSE:**
```json
{
  "payload": {
    "parity_choice": "even",  // or "odd"
    "number": 7               // 1-10
  }
}
```

**Related Errors:** E002 (INVALID_MESSAGE_FORMAT)
**Documentation:** SHARED/config/games/games_registry.json (even_odd game rules)

---

## E011: PROTOCOL_VERSION_MISMATCH
**Category:** Configuration
**Severity:** Error
**Retryable:** No
**Exit Code:** 1

**Typical Causes:**
- Agent using wrong protocol version
- Protocol field not set to "league.v2"
- Outdated agent code

**Suggested Actions:**
1. Verify protocol field in all messages: `"protocol": "league.v2"`
2. Update agent to latest version
3. Check MessageEnvelope default: `protocol: Literal["league.v2"] = "league.v2"`

**Related Errors:** E002 (INVALID_MESSAGE_FORMAT)
**Documentation:** SHARED/league_sdk/protocol.py

---

## E012: AUTH_TOKEN_INVALID
**Category:** Authentication
**Severity:** Error
**Retryable:** No
**Exit Code:** 3

**Typical Causes:**
- Missing auth_token in message (when require_auth=true)
- Wrong auth_token (doesn't match registered token)
- Sending auth_token="" for non-registration messages

**Suggested Actions:**
1. Check registration status: `./scripts/check_registration_status.sh`
2. Re-register if needed: Use `manual_register` MCP tool
3. Verify require_auth setting: `cat SHARED/config/system.json | jq '.security.require_auth'`
4. Check auth_token in message matches registered token

**Auth Token Rules:**
- Registration messages: `auth_token=""`
- All other messages: `auth_token=<token_from_registration_response>`

**Related Errors:** E003 (AUTHENTICATION_FAILED), E004 (AGENT_NOT_REGISTERED)
**Documentation:** doc/system_integration_verification_plan.md#10-auth-token-verification

---

## E013: CONVERSATION_ID_MISMATCH
**Category:** Game State
**Severity:** Error
**Retryable:** No

**Typical Causes:**
- Using wrong conversation_id in response
- Responding to different match than invited to
- Copy-paste error in implementation

**Suggested Actions:**
1. Always echo conversation_id from received message
2. Maintain conversation_id throughout match lifecycle
3. Check logs for conversation_id flow: `./scripts/analyze_logs.sh MESSAGE_RECEIVED`

**Correct Pattern:**
```python
# Receive invitation
invitation = received_message  # conversation_id = "conv-M001"

# Send response with SAME conversation_id
response = {
    "conversation_id": invitation["conversation_id"],  # Echo back
    ...
}
```

**Related Errors:** E007 (MATCH_NOT_FOUND)
**Documentation:** SHARED/league_sdk/protocol.py (MessageEnvelope.conversation_id field)

---

## E014: RATE_LIMIT_EXCEEDED
**Category:** Network/System
**Severity:** Warning
**Retryable:** Yes

**Typical Causes:**
- Too many requests in short time
- Circuit breaker activated
- DOS protection triggered

**Suggested Actions:**
1. Wait and retry (system handles this automatically)
2. Check request rate in code
3. Increase rate limits if legitimate: `SHARED/config/system.json` (network.max_connections)
4. Review circuit breaker settings: `retry_policy.circuit_breaker_threshold`

**Related Errors:** E015 (INTERNAL_SERVER_ERROR), E016 (SERVICE_UNAVAILABLE)
**Documentation:** SHARED/league_sdk/retry.py (CircuitBreakerManager class)

---

## E015: INTERNAL_SERVER_ERROR
**Category:** Network/System
**Severity:** Error
**Retryable:** Yes

**Typical Causes:**
- Unhandled exception in agent code
- Database/repository write failure
- Unexpected runtime error

**Suggested Actions:**
1. Check agent logs for stack traces: `./scripts/analyze_logs.sh GAME_ERROR`
2. System will retry automatically (retryable error)
3. If persists, restart agent
4. Report bug if reproducible

**Related Errors:** E016 (SERVICE_UNAVAILABLE)
**Documentation:** agents/*/server.py (exception handlers)

---

## E016: SERVICE_UNAVAILABLE
**Category:** Network/System
**Severity:** Warning
**Retryable:** Yes

**Typical Causes:**
- Agent not running
- Network unreachable
- Port not listening
- Circuit breaker OPEN

**Suggested Actions:**
1. Check agent health: `./scripts/check_health.sh`
2. Check if agent running: `ps aux | grep agents`
3. Check network: `netstat -an | grep <port>`
4. Restart agent: `./scripts/start_league.sh`
5. System will retry automatically (retryable error)

**Related Errors:** E001 (TIMEOUT_ERROR), E006 (PLAYER_NOT_AVAILABLE), E018 (INVALID_ENDPOINT)
**Documentation:** doc/system_integration_verification_plan.md#13-common-failure-points

---

## E017: DUPLICATE_REGISTRATION
**Category:** Authentication
**Severity:** Warning
**Retryable:** No

**Typical Causes:**
- Agent already registered
- Calling register twice
- Auto-register enabled but manual_register also called

**Suggested Actions:**
1. Check registration status first: `get_registration_status` MCP tool
2. Skip registration if already registered (status: "ALREADY_REGISTERED")
3. If intentional re-registration needed, de-register first (if supported)

**Related Errors:** E004 (AGENT_NOT_REGISTERED)
**Documentation:** agents/*/server.py (registration handlers)

---

## E018: INVALID_ENDPOINT
**Category:** Configuration
**Severity:** Error
**Retryable:** No
**Exit Code:** 2

**Typical Causes:**
- Malformed URL in agents_config.json
- Wrong protocol (http vs https)
- Invalid host/port combination
- DNS resolution failure

**Suggested Actions:**
1. Validate endpoint format: `http://<host>:<port>/mcp`
2. Check agents_config.json: `cat SHARED/config/agents/agents_config.json | jq '.players[] | .endpoint'`
3. Test endpoint: `curl http://localhost:8101/health`
4. Verify network configuration

**Valid Endpoint Examples:**
```
http://localhost:8000/mcp       ‚úì Valid
http://0.0.0.0:8101/mcp         ‚úì Valid
https://api.example.com/mcp     ‚úì Valid (if using HTTPS)
localhost:8000                  ‚úó Invalid (missing protocol)
http://localhost/mcp            ‚úó Invalid (missing port)
```

**Related Errors:** E016 (SERVICE_UNAVAILABLE)
**Documentation:** SHARED/config/agents/agents_config.json

---

## Quick Reference Table

| Code | Name | Severity | Retryable | Exit Code | Category |
|------|------|----------|-----------|-----------|----------|
| E001 | TIMEOUT_ERROR | Warning | Yes | - | Network |
| E002 | INVALID_MESSAGE_FORMAT | Error | No | 1 | Config |
| E003 | AUTHENTICATION_FAILED | Error | No | 3 | Auth |
| E004 | AGENT_NOT_REGISTERED | Error | No | 3 | Auth |
| E005 | INVALID_GAME_STATE | Warning | Yes | - | Game |
| E006 | PLAYER_NOT_AVAILABLE | Warning | Yes | - | Network |
| E007 | MATCH_NOT_FOUND | Error | No | - | Game |
| E008 | LEAGUE_NOT_FOUND | Error | No | 1 | Config |
| E009 | ROUND_NOT_ACTIVE | Warning | Yes | - | Game |
| E010 | INVALID_MOVE | Error | No | - | Game |
| E011 | PROTOCOL_VERSION_MISMATCH | Error | No | 1 | Config |
| E012 | AUTH_TOKEN_INVALID | Error | No | 3 | Auth |
| E013 | CONVERSATION_ID_MISMATCH | Error | No | - | Game |
| E014 | RATE_LIMIT_EXCEEDED | Warning | Yes | - | Network |
| E015 | INTERNAL_SERVER_ERROR | Error | Yes | 4 | System |
| E016 | SERVICE_UNAVAILABLE | Warning | Yes | 2 | Network |
| E017 | DUPLICATE_REGISTRATION | Warning | No | - | Auth |
| E018 | INVALID_ENDPOINT | Error | No | 2 | Config |

---

## Exit Code Summary

- **0:** Success - agent running normally
- **1:** Configuration error (E002, E008, E011)
- **2:** Network error (E016, E018)
- **3:** Authentication/registration error (E003, E004, E012)
- **4:** Runtime error (E015)

---

## Retry Policy

**Retryable Errors** (7 total): E001, E005, E006, E009, E014, E015, E016

**Retry Configuration:**
```json
// SHARED/config/system.json
"retry_policy": {
  "max_retries": 3,
  "initial_backoff_ms": 1000,
  "max_backoff_ms": 10000,
  "backoff_multiplier": 2.0,
  "circuit_breaker_threshold": 5,
  "circuit_breaker_timeout_sec": 60
}
```

**Non-Retryable Errors** (11 total): E002, E003, E004, E007, E008, E010, E011, E012, E013, E017, E018

These errors indicate permanent failures that won't resolve with retries.

---

## See Also

- **System Integration Plan:** doc/system_integration_verification_plan.md
- **Protocol Specification:** SHARED/league_sdk/protocol.py
- **Retry Logic:** SHARED/league_sdk/retry.py
- **Troubleshooting Guide:** doc/troubleshooting.md
- **Configuration Reference:** doc/configuration.md
```

**Self-Verify:**
```bash
ls -lh doc/error_codes_reference.md
wc -l doc/error_codes_reference.md  # Should be ~600-700 lines
grep "^## E0" doc/error_codes_reference.md | wc -l  # Should be 18
```

---

### Task 1.5.2: Create Shared Script Functions Library

**File:** `scripts/lib/common.sh`

**Purpose:** Shared functions for accessibility, logging, and error handling

**Implementation:**

```bash
#!/bin/bash
#
# Common functions library for all league scripts
# Source this file at the top of each script: source "$(dirname "$0")/lib/common.sh"
#

# ============================================================================
# GLOBALS
# ============================================================================

PLAIN_OUTPUT=${PLAIN_OUTPUT:-false}
VERBOSE=${VERBOSE:-false}
QUIET=${QUIET:-false}

# ============================================================================
# OUTPUT FUNCTIONS (Accessibility-Compliant)
# ============================================================================

log_info() {
    [ "$QUIET" = true ] && return
    if [ "$PLAIN_OUTPUT" = true ]; then
        echo "[INFO] $1"
    else
        echo "‚ÑπÔ∏è  $1"
    fi
}

log_success() {
    [ "$QUIET" = true ] && return
    if [ "$PLAIN_OUTPUT" = true ]; then
        echo "[SUCCESS] $1"
    else
        echo "‚úÖ $1"
    fi
}

log_error() {
    local error_code="${2:-}"
    if [ "$PLAIN_OUTPUT" = true ]; then
        if [ -n "$error_code" ]; then
            echo "[ERROR] [$error_code] $1" >&2
        else
            echo "[ERROR] $1" >&2
        fi
    else
        if [ -n "$error_code" ]; then
            echo "‚ùå [$error_code] $1" >&2
        else
            echo "‚ùå $1" >&2
        fi
    fi
}

log_warning() {
    [ "$QUIET" = true ] && return
    local error_code="${2:-}"
    if [ "$PLAIN_OUTPUT" = true ]; then
        if [ -n "$error_code" ]; then
            echo "[WARNING] [$error_code] $1"
        else
            echo "[WARNING] $1"
        fi
    else
        if [ -n "$error_code" ]; then
            echo "‚ö†Ô∏è  [$error_code] $1"
        else
            echo "‚ö†Ô∏è  $1"
        fi
    fi
}

log_debug() {
    [ "$VERBOSE" != true ] && return
    if [ "$PLAIN_OUTPUT" = true ]; then
        echo "[DEBUG] $1"
    else
        echo "üîç $1"
    fi
}

log_step() {
    [ "$QUIET" = true ] && return
    if [ "$PLAIN_OUTPUT" = true ]; then
        echo "[STEP] $1"
    else
        echo "‚ñ∂Ô∏è  $1"
    fi
}

# ============================================================================
# ERROR HANDLING WITH RECOVERY SUGGESTIONS
# ============================================================================

# Show error with recovery suggestions
# Usage: show_error "E001" "Connection timeout" "step_name"
show_error() {
    local error_code="$1"
    local error_msg="$2"
    local context="${3:-}"

    log_error "$error_msg" "$error_code"
    echo ""

    case "$error_code" in
        E001)
            echo "Suggested actions:"
            echo "  1. Check agent health: ./scripts/check_health.sh"
            echo "  2. Check network: ping localhost"
            echo "  3. Increase timeout in SHARED/config/system.json"
            echo ""
            echo "Documentation: doc/error_codes_reference.md#e001-timeout_error"
            ;;
        E002)
            echo "Suggested actions:"
            echo "  1. Validate JSON: python3 -m json.tool <file>"
            echo "  2. Check message format against protocol.py"
            echo "  3. Verify required fields present"
            echo ""
            echo "Documentation: doc/error_codes_reference.md#e002-invalid_message_format"
            ;;
        E004)
            echo "Suggested actions:"
            echo "  1. Check registration: ./scripts/check_registration_status.sh"
            echo "  2. Register manually via MCP tool"
            echo "  3. Restart with auto-register enabled"
            echo ""
            echo "Documentation: doc/error_codes_reference.md#e004-agent_not_registered"
            ;;
        E008)
            echo "Suggested actions:"
            echo "  1. List leagues: ls SHARED/config/leagues/"
            echo "  2. Verify league_id spelling"
            echo "  3. Create league config if missing"
            echo ""
            echo "Documentation: doc/error_codes_reference.md#e008-league_not_found"
            ;;
        E016)
            echo "Suggested actions:"
            echo "  1. Check service: ./scripts/check_health.sh"
            echo "  2. Start agents: ./scripts/start_league.sh"
            echo "  3. Check network: netstat -an | grep <port>"
            echo ""
            echo "Documentation: doc/error_codes_reference.md#e016-service_unavailable"
            ;;
        E018)
            echo "Suggested actions:"
            echo "  1. Validate endpoint format: http://<host>:<port>/mcp"
            echo "  2. Check agents_config.json"
            echo "  3. Test endpoint: curl http://localhost:<port>/health"
            echo ""
            echo "Documentation: doc/error_codes_reference.md#e018-invalid_endpoint"
            ;;
        *)
            echo "See doc/error_codes_reference.md for recovery suggestions"
            ;;
    esac
}

# ============================================================================
# VALIDATION FUNCTIONS
# ============================================================================

validate_port() {
    local port=$1
    if ! [[ "$port" =~ ^[0-9]+$ ]] || [ "$port" -lt 1024 ] || [ "$port" -gt 65535 ]; then
        show_error "E018" "Invalid port: $port (must be 1024-65535)"
        return 1
    fi
    return 0
}

validate_agent_id() {
    local agent_id=$1
    if ! [[ "$agent_id" =~ ^[A-Z0-9]+$ ]]; then
        show_error "E002" "Invalid agent ID: $agent_id (must be alphanumeric uppercase)"
        return 1
    fi
    return 0
}

validate_file_exists() {
    local file=$1
    if [ ! -f "$file" ]; then
        show_error "E002" "File not found: $file"
        return 1
    fi
    return 0
}

validate_json_file() {
    local file=$1
    if ! python3 -m json.tool "$file" > /dev/null 2>&1; then
        show_error "E002" "Invalid JSON in: $file"
        return 1
    fi
    return 0
}

# ============================================================================
# ARGUMENT PARSING
# ============================================================================

parse_common_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            --plain)
                PLAIN_OUTPUT=true
                export PLAIN_OUTPUT
                shift
                ;;
            --verbose|-v)
                VERBOSE=true
                export VERBOSE
                shift
                ;;
            --quiet|-q)
                QUIET=true
                export QUIET
                shift
                ;;
            --help|-h)
                return 1  # Signal to show help
                ;;
            *)
                # Unknown arg, let caller handle
                break
                ;;
        esac
    done
    return 0
}

# ============================================================================
# UTILITY FUNCTIONS
# ============================================================================

check_command() {
    local cmd=$1
    if ! command -v "$cmd" &> /dev/null; then
        log_error "Required command not found: $cmd"
        return 1
    fi
    return 0
}

check_port_available() {
    local port=$1
    if lsof -i:$port > /dev/null 2>&1; then
        return 1  # Port in use
    fi
    return 0  # Port available
}

get_project_root() {
    local script_dir="$(cd "$(dirname "${BASH_SOURCE[1]}")" && pwd)"
    cd "$script_dir/.." && pwd
}
```

**Self-Verify:**
```bash
mkdir -p scripts/lib
ls -lh scripts/lib/common.sh
bash -n scripts/lib/common.sh
```

---

### Task 1.5.3: Update All Existing Scripts to Use Common Library

**Files to Update:**
- `scripts/start_league.sh`
- `scripts/stop_league.sh`
- `scripts/check_health.sh`

**Changes to Each Script:**

```bash
#!/bin/bash
#
# Script description
# Usage: ./script.sh [options]
#

set -e

# ============================================================================
# SETUP
# ============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Source common library
source "$SCRIPT_DIR/lib/common.sh"

# ============================================================================
# USAGE
# ============================================================================

show_usage() {
    cat << EOF
Usage: $(basename "$0") [options] [args]

Description: [Script-specific description]

Options:
  --plain       Plain text output (no emojis, for screen readers)
  --verbose     Verbose output (show all details)
  --quiet       Minimal output (errors only)
  --help        Show this help message

Examples:
  # Normal mode
  ./$(basename "$0")

  # Plain text for accessibility
  ./$(basename "$0") --plain

  # Verbose for debugging
  ./$(basename "$0") --verbose

Exit Codes:
  0   Success
  1   Configuration error
  2   Network error
  3   Registration error
  4   Runtime error

Documentation:
  Error Codes: doc/error_codes_reference.md
  System Integration: doc/system_integration_verification_plan.md

EOF
}

# ============================================================================
# ARGUMENT PARSING
# ============================================================================

if ! parse_common_args "$@"; then
    show_usage
    exit 0
fi

# Parse script-specific args here...

# ============================================================================
# MAIN LOGIC
# ============================================================================

log_step "Starting [Script Name]"
echo "=========================================="

# Use log_info, log_success, log_error, etc.
log_info "Step 1: Doing something..."
# ... logic ...
log_success "Step 1 complete"

# On error:
if [ $? -ne 0 ]; then
    show_error "E016" "Service unavailable" "check_health"
    exit 2
fi

echo ""
echo "=========================================="
log_success "Script completed successfully"
exit 0
```

---

## PHASE 2: CORE OPERATIONAL SCRIPTS (M6.2)

**Estimated Time:** 1 hour
**Priority:** P1

### Task 2.1: Create backup_data.sh

**File:** `scripts/backup_data.sh`

**Implementation:**

```bash
#!/bin/bash
#
# Backup league data and logs to timestamped archive
# Usage: ./scripts/backup_data.sh [backup_name] [options]
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

source "$SCRIPT_DIR/lib/common.sh"

# ============================================================================
# USAGE
# ============================================================================

show_usage() {
    cat << EOF
Usage: $(basename "$0") [backup_name] [options]

Description: Backup SHARED/data/ and SHARED/logs/ to timestamped archive

Arguments:
  backup_name   Custom backup name (default: backup_YYYYMMDD_HHMMSS)

Options:
  --plain       Plain text output (no emojis)
  --verbose     Show detailed backup process
  --quiet       Only show errors
  --dry-run     Show what would be backed up without creating archive
  --help        Show this help message

Examples:
  # Create backup with auto-generated name
  ./scripts/backup_data.sh

  # Create backup with custom name
  ./scripts/backup_data.sh pre_migration_backup

  # Dry run to see what would be backed up
  ./scripts/backup_data.sh --dry-run

  # Plain output for CI/CD
  ./scripts/backup_data.sh production_backup_20250127 --plain --quiet

Exit Codes:
  0   Success - backup created
  1   Configuration error (no data to backup)
  4   Runtime error (tar failed)

Storage:
  Backups saved to: backups/
  Format: .tar.gz (compressed)

Documentation:
  Restore: ./scripts/restore_data.sh
  Error Codes: doc/error_codes_reference.md

EOF
}

# ============================================================================
# ARGUMENT PARSING
# ============================================================================

DRY_RUN=false
BACKUP_NAME=""

while [[ $# -gt 0 ]]; do
    if ! parse_common_args "$@"; then
        show_usage
        exit 0
    fi

    case $1 in
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --help|-h)
            show_usage
            exit 0
            ;;
        -*)
            log_error "Unknown option: $1"
            show_usage
            exit 1
            ;;
        *)
            BACKUP_NAME="$1"
            shift
            ;;
    esac
done

# ============================================================================
# MAIN LOGIC
# ============================================================================

BACKUP_DIR="$PROJECT_ROOT/backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="${BACKUP_NAME:-backup_$TIMESTAMP}"
BACKUP_FILE="$BACKUP_DIR/${BACKUP_NAME}.tar.gz"

log_step "Creating backup: $BACKUP_NAME"
if [ "$DRY_RUN" = true ]; then
    log_info "DRY RUN MODE - No backup will be created"
fi
echo "=========================================="

# Create backup directory
mkdir -p "$BACKUP_DIR"
log_debug "Backup directory: $BACKUP_DIR"

# Check if data/logs exist
if [ ! -d "$PROJECT_ROOT/SHARED/data" ] && [ ! -d "$PROJECT_ROOT/SHARED/logs" ]; then
    show_error "E002" "No data or logs to backup"
    exit 1
fi

# Show what will be backed up
log_info "Scanning files to backup..."
DATA_COUNT=0
LOGS_COUNT=0

if [ -d "$PROJECT_ROOT/SHARED/data" ]; then
    DATA_COUNT=$(find "$PROJECT_ROOT/SHARED/data" -type f | wc -l)
    log_info "Data files: $DATA_COUNT"
fi

if [ -d "$PROJECT_ROOT/SHARED/logs" ]; then
    LOGS_COUNT=$(find "$PROJECT_ROOT/SHARED/logs" -type f | wc -l)
    log_info "Log files: $LOGS_COUNT"
fi

TOTAL_COUNT=$((DATA_COUNT + LOGS_COUNT))
log_info "Total files: $TOTAL_COUNT"

if [ "$DRY_RUN" = true ]; then
    echo ""
    log_success "Dry run complete - would backup $TOTAL_COUNT files"
    echo "Run without --dry-run to create backup: $BACKUP_FILE"
    exit 0
fi

# Create compressed archive
log_step "Creating compressed archive..."
cd "$PROJECT_ROOT"

tar -czf "$BACKUP_FILE" \
    $([ -d "SHARED/data" ] && echo "SHARED/data") \
    $([ -d "SHARED/logs" ] && echo "SHARED/logs") \
    2>/dev/null || {
        show_error "E015" "Backup creation failed (tar error)"
        exit 4
    }

# Verify backup
if [ ! -f "$BACKUP_FILE" ]; then
    show_error "E015" "Backup file not created"
    exit 4
fi

BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
log_success "Backup created: $BACKUP_FILE"
log_info "Size: $BACKUP_SIZE"
log_info "Files: $TOTAL_COUNT"

echo ""
echo "To restore: ./scripts/restore_data.sh $BACKUP_NAME"
echo "=========================================="
log_success "Backup complete"
exit 0
```

**Self-Verify:**
```bash
chmod +x scripts/backup_data.sh
bash -n scripts/backup_data.sh
./scripts/backup_data.sh --help
./scripts/backup_data.sh --dry-run
```

---

### Task 2.2: Create restore_data.sh

**File:** `scripts/restore_data.sh`

**Implementation:** (Similar structure to backup_data.sh, with restore logic)

```bash
#!/bin/bash
#
# Restore league data and logs from backup archive
# Usage: ./scripts/restore_data.sh <backup_name> [options]
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

source "$SCRIPT_DIR/lib/common.sh"

# ============================================================================
# USAGE
# ============================================================================

show_usage() {
    cat << EOF
Usage: $(basename "$0") <backup_name> [options]

Description: Restore SHARED/data/ and SHARED/logs/ from backup archive

Arguments:
  backup_name   Name of backup to restore (without .tar.gz extension)
                Run without arguments to list available backups

Options:
  --plain       Plain text output (no emojis)
  --verbose     Show detailed restore process
  --quiet       Only show errors
  --dry-run     Show what would be restored without extracting
  --force       Skip confirmation prompt (dangerous!)
  --help        Show this help message

Examples:
  # List available backups
  ./scripts/restore_data.sh

  # Restore specific backup (with confirmation)
  ./scripts/restore_data.sh backup_20250127_143022

  # Restore without confirmation (use with caution!)
  ./scripts/restore_data.sh backup_20250127_143022 --force

  # Dry run to see what would be restored
  ./scripts/restore_data.sh backup_20250127_143022 --dry-run

Exit Codes:
  0   Success - backup restored
  1   Configuration error (backup not found)
  4   Runtime error (tar extraction failed)

WARNING:
  This will OVERWRITE existing data and logs!
  Always backup current data before restoring.

Documentation:
  Backup: ./scripts/backup_data.sh
  Error Codes: doc/error_codes_reference.md

EOF
}

# ============================================================================
# ARGUMENT PARSING
# ============================================================================

DRY_RUN=false
FORCE=false
BACKUP_NAME=""

while [[ $# -gt 0 ]]; do
    if ! parse_common_args "$@"; then
        show_usage
        exit 0
    fi

    case $1 in
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --force)
            FORCE=true
            shift
            ;;
        --help|-h)
            show_usage
            exit 0
            ;;
        -*)
            log_error "Unknown option: $1"
            show_usage
            exit 1
            ;;
        *)
            BACKUP_NAME="$1"
            shift
            ;;
    esac
done

# ============================================================================
# MAIN LOGIC
# ============================================================================

BACKUP_DIR="$PROJECT_ROOT/backups"

# List backups if no argument
if [ -z "$BACKUP_NAME" ]; then
    log_step "Available backups"
    echo "=========================================="
    if [ -d "$BACKUP_DIR" ]; then
        BACKUP_COUNT=$(ls "$BACKUP_DIR"/*.tar.gz 2>/dev/null | wc -l)
        if [ "$BACKUP_COUNT" -gt 0 ]; then
            ls -lh "$BACKUP_DIR"/*.tar.gz | awk '{print $9, "(" $5 ")"}'
            echo ""
            log_info "Total backups: $BACKUP_COUNT"
        else
            log_warning "No backups found"
        fi
    else
        log_warning "Backup directory not found: $BACKUP_DIR"
    fi
    echo ""
    log_info "Usage: ./scripts/restore_data.sh <backup_name>"
    exit 0
fi

BACKUP_FILE="$BACKUP_DIR/${BACKUP_NAME}.tar.gz"

# Validate backup exists
if [ ! -f "$BACKUP_FILE" ]; then
    show_error "E002" "Backup not found: $BACKUP_FILE"
    echo ""
    log_info "Run without arguments to see available backups"
    exit 1
fi

log_step "Restoring backup: $BACKUP_NAME"
if [ "$DRY_RUN" = true ]; then
    log_info "DRY RUN MODE - No files will be restored"
fi
echo "=========================================="

# Show backup info
BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
log_info "Backup file: $BACKUP_FILE"
log_info "Size: $BACKUP_SIZE"

# List contents
log_info "Backup contents:"
tar -tzf "$BACKUP_FILE" | head -10
TOTAL_FILES=$(tar -tzf "$BACKUP_FILE" | wc -l)
if [ "$TOTAL_FILES" -gt 10 ]; then
    log_info "... and $((TOTAL_FILES - 10)) more files"
fi

# Warn about overwrite
if [ -d "$PROJECT_ROOT/SHARED/data" ] || [ -d "$PROJECT_ROOT/SHARED/logs" ]; then
    echo ""
    if [ "$PLAIN_OUTPUT" = true ]; then
        echo "[WARNING] This will OVERWRITE existing data and logs!"
    else
        echo "‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è  WARNING ‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è"
        echo "This will OVERWRITE existing data and logs!"
    fi
    echo ""

    if [ "$FORCE" != true ] && [ "$DRY_RUN" != true ]; then
        read -p "Continue? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            log_info "Restore cancelled"
            exit 0
        fi
    elif [ "$FORCE" = true ]; then
        log_warning "Skipping confirmation (--force enabled)"
    fi
fi

if [ "$DRY_RUN" = true ]; then
    echo ""
    log_success "Dry run complete - would restore $TOTAL_FILES files"
    echo "Run without --dry-run to restore: $BACKUP_FILE"
    exit 0
fi

# Extract backup
log_step "Extracting backup..."
cd "$PROJECT_ROOT"

tar -xzf "$BACKUP_FILE" 2>/dev/null || {
    show_error "E015" "Restore failed (tar extraction error)"
    exit 4
}

log_success "Backup restored from: $BACKUP_FILE"
log_info "Restored:"
[ -d "SHARED/data" ] && log_info "  - SHARED/data/ ($DATA_COUNT files)"
[ -d "SHARED/logs" ] && log_info "  - SHARED/logs/ ($LOGS_COUNT files)"

echo ""
echo "=========================================="
log_success "Restore complete"
exit 0
```

**Self-Verify:**
```bash
chmod +x scripts/restore_data.sh
bash -n scripts/restore_data.sh
./scripts/restore_data.sh --help
./scripts/restore_data.sh  # List backups
```

---

### Task 2.3: Update start_league.sh with Enhanced Features

**File:** `scripts/start_league.sh`

**Changes:**
1. Source common.sh library
2. Add --plain, --verbose, --quiet flags
3. Use CLI args for players instead of env vars
4. Add validation and error handling
5. Add --dry-run mode

**Key Updates:**

```bash
#!/bin/bash
#
# Start all agents for Even/Odd League
# Usage: ./scripts/start_league.sh [league_id] [options]
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

source "$SCRIPT_DIR/lib/common.sh"

# ... (usage function, arg parsing, etc.) ...

# Updated player startup with CLI args
log_step "Starting players..."
python3 -m agents.player_P01.main \
    --player-id P01 \
    --league-id "$LEAGUE_ID" \
    --port 8101 \
    $([ "$PLAIN_OUTPUT" = true ] && echo "--plain") \
    $([ "$VERBOSE" = true ] && echo "--verbose") \
    $([ "$QUIET" = true ] && echo "--quiet") \
    > logs/player_P01.log 2>&1 &
P01_PID=$!
log_success "Player P01 started (PID: $P01_PID)"

# Repeat for P02, P03, P04...
```

---

## PHASE 3: VERIFICATION STAGE SCRIPTS

**Estimated Time:** 1 hour
**Priority:** P1

All verification scripts follow the same enhanced pattern with:
- Common library sourcing
- --plain, --verbose, --quiet flags
- Error codes with recovery suggestions
- Comprehensive help text

### Task 3.1-3.7: Create Verification Scripts

Scripts to create (with enhanced features):
1. `scripts/verify_configs.sh` - Step 0: Config validation
2. `scripts/check_registration_status.sh` - Steps 2-3: Registration check
3. `scripts/trigger_league_start.sh` - Step 4: League orchestration
4. `scripts/query_standings.sh` - Runtime: Standings query
5. `scripts/view_match_state.sh` - Step 5: Match inspection
6. `scripts/analyze_logs.sh` - All steps: Log analysis
7. `scripts/cleanup_old_data.sh` - Step 8: Cleanup

**(Each script follows the same enhanced pattern as backup_data.sh with accessibility, error handling, and documentation)**

---

## PHASE 4: TESTING & VALIDATION

**Estimated Time:** 1 hour
**Priority:** P0

### Task 4.1: Integration Test - Full Workflow

**Test Script:** `tests/manual/test_full_workflow.sh`

```bash
#!/bin/bash
#
# Integration test: Full league workflow with new scripts
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

cd "$PROJECT_ROOT"

echo "=========================================="
echo "INTEGRATION TEST: Full League Workflow"
echo "=========================================="

# Step 0: Verify configs
echo ""
echo "Step 0: Verify configs..."
./scripts/verify_configs.sh --plain || exit 1

# Step 1: Start league
echo ""
echo "Step 1: Start league..."
./scripts/start_league.sh --plain || exit 1
sleep 5

# Step 2: Check health
echo ""
echo "Step 2: Check health..."
./scripts/check_health.sh --plain || exit 1

# Step 3: Check registration
echo ""
echo "Step 3: Check registration..."
./scripts/check_registration_status.sh --plain || exit 1

# Step 4: Trigger league start
echo ""
echo "Step 4: Trigger league start..."
./scripts/trigger_league_start.sh --plain || exit 1

# Step 5: Query standings
echo ""
echo "Step 5: Query standings..."
./scripts/query_standings.sh --plain || exit 1

# Step 6: Backup data
echo ""
echo "Step 6: Backup data..."
./scripts/backup_data.sh integration_test_$(date +%Y%m%d_%H%M%S) --plain || exit 1

# Step 7: Analyze logs
echo ""
echo "Step 7: Analyze logs..."
./scripts/analyze_logs.sh MESSAGE_SENT --plain || exit 1

# Step 8: Stop league
echo ""
echo "Step 8: Stop league..."
./scripts/stop_league.sh --plain || exit 1

echo ""
echo "=========================================="
echo "‚úÖ INTEGRATION TEST PASSED"
echo "=========================================="
exit 0
```

### Task 4.2: Accessibility Test

**Test Script:** `tests/manual/test_accessibility.sh`

```bash
#!/bin/bash
#
# Test accessibility features (--plain mode, no emoji dependencies)
#

set -e

echo "=========================================="
echo "ACCESSIBILITY TEST"
echo "=========================================="

# Test 1: All scripts support --plain flag
echo ""
echo "Test 1: --plain flag support..."
for SCRIPT in scripts/*.sh; do
    if [ -x "$SCRIPT" ]; then
        echo "Testing: $SCRIPT"
        "$SCRIPT" --help | grep -q "\--plain" || {
            echo "‚ùå FAIL: $SCRIPT doesn't support --plain"
            exit 1
        }
    fi
done
echo "‚úÖ All scripts support --plain"

# Test 2: Plain output has no emojis
echo ""
echo "Test 2: Plain output emoji-free..."
OUTPUT=$(./scripts/check_health.sh --plain 2>&1 || true)
if echo "$OUTPUT" | grep -q "[‚úÖ‚ùå‚ö†Ô∏èüéÆ‚öñÔ∏èüìãüîçüöÄ]"; then
    echo "‚ùå FAIL: Plain output contains emojis"
    exit 1
fi
echo "‚úÖ Plain output is emoji-free"

# Test 3: All agents support --plain
echo ""
echo "Test 3: Agent --plain support..."
python -m agents.player_P01.main --help | grep -q "\--plain" || {
    echo "‚ùå FAIL: Player agents don't support --plain"
    exit 1
}
echo "‚úÖ All agents support --plain"

echo ""
echo "=========================================="
echo "‚úÖ ACCESSIBILITY TESTS PASSED"
echo "=========================================="
exit 0
```

### Task 4.3: CLI Argument Validation Test

**Test Script:** `tests/manual/test_cli_validation.sh`

```bash
#!/bin/bash
#
# Test CLI argument validation and error handling
#

set -e

echo "=========================================="
echo "CLI VALIDATION TEST"
echo "=========================================="

# Test 1: --help works for all agents
echo ""
echo "Test 1: --help for all agents..."
for AGENT in league_manager player_P01 player_P02 player_P03 player_P04 referee_REF01 referee_REF02; do
    echo "Testing: $AGENT"
    python -m agents.${AGENT}.main --help > /dev/null || {
        echo "‚ùå FAIL: $AGENT --help failed"
        exit 1
    }
done
echo "‚úÖ All agents support --help"

# Test 2: --version works
echo ""
echo "Test 2: --version for all agents..."
for AGENT in league_manager player_P01 referee_REF01; do
    echo "Testing: $AGENT"
    python -m agents.${AGENT}.main --version 2>&1 | grep -q "1.0.0" || {
        echo "‚ùå FAIL: $AGENT --version failed"
        exit 1
    }
done
echo "‚úÖ All agents support --version"

# Test 3: Invalid args rejected
echo ""
echo "Test 3: Invalid argument rejection..."
python -m agents.player_P01.main --invalid-arg 2>&1 | grep -q "error: unrecognized arguments" || {
    echo "‚ùå FAIL: Invalid args not rejected"
    exit 1
}
echo "‚úÖ Invalid arguments rejected correctly"

# Test 4: Mutually exclusive args
echo ""
echo "Test 4: Mutually exclusive args..."
python -m agents.player_P01.main --verbose --quiet 2>&1 | grep -q "mutually exclusive" || {
    echo "‚ùå FAIL: --verbose and --quiet should be mutually exclusive"
    exit 1
}
echo "‚úÖ Mutually exclusive args validated"

# Test 5: Port validation
echo ""
echo "Test 5: Port validation..."
python -m agents.player_P01.main --port 100 2>&1 | grep -q "must be between 1024-65535" || {
    echo "‚ùå FAIL: Invalid port not rejected"
    exit 1
}
echo "‚úÖ Port validation works"

echo ""
echo "=========================================="
echo "‚úÖ CLI VALIDATION TESTS PASSED"
echo "=========================================="
exit 0
```

---

## PHASE 5: DOCUMENTATION UPDATE

**Estimated Time:** 30 minutes
**Priority:** P1

### Task 5.1: Update README.md

**Add to README.md:**

```markdown
## CLI Usage

All agents support comprehensive command-line arguments for configuration:

### Common Arguments (All Agents)

| Argument | Description | Default | Example |
|----------|-------------|---------|---------|
| `--help` | Show usage information | - | `--help` |
| `--version` | Show agent version | - | `--version` |
| `--log-level` | Set logging level | INFO | `--log-level DEBUG` |
| `--verbose` | Verbose output (debug mode) | false | `--verbose` |
| `--quiet` | Minimal output (errors only) | false | `--quiet` |
| `--plain` | Plain text (no emojis, for screen readers) | false | `--plain` |
| `--json` | JSON output (for automation) | false | `--json` |
| `--config` | Custom config directory | SHARED/config | `--config /path/to/config` |

### Agent-Specific Arguments

**League Manager:**
```bash
python -m agents.league_manager.main \
    --league-id league_2025_even_odd \
    --host 0.0.0.0 \
    --port 8000 \
    --log-level INFO
```

**Referees:**
```bash
python -m agents.referee_REF01.main \
    --referee-id REF01 \
    --league-id league_2025_even_odd \
    --host 0.0.0.0 \
    --port 8001 \
    --log-level INFO
```

**Players:**
```bash
python -m agents.player_P01.main \
    --player-id P01 \
    --league-id league_2025_even_odd \
    --host 0.0.0.0 \
    --port 8101 \
    --log-level INFO
```

### Accessibility Features

All agents and scripts support **--plain** mode for screen reader compatibility:

```bash
# Plain text output (no emojis)
python -m agents.player_P01.main --plain
./scripts/check_health.sh --plain

# JSON output for automation
python -m agents.league_manager.main --json

# Verbose mode for debugging
./scripts/start_league.sh --verbose
```

### Exit Codes

All agents use standard exit codes:

| Code | Meaning | Examples |
|------|---------|----------|
| 0 | Success | Agent running normally |
| 1 | Configuration error | E002, E008, E011 |
| 2 | Network error | E016, E018 |
| 3 | Authentication error | E003, E004, E012 |
| 4 | Runtime error | E015 |

See `doc/error_codes_reference.md` for detailed error code documentation.

---

## Operational Scripts

### Core Operations

| Script | Description | Example |
|--------|-------------|---------|
| `scripts/start_league.sh` | Start all agents (LM + 2 refs + 4 players) | `./scripts/start_league.sh` |
| `scripts/stop_league.sh` | Graceful shutdown of all agents | `./scripts/stop_league.sh` |
| `scripts/check_health.sh` | Health check all endpoints | `./scripts/check_health.sh` |
| `scripts/backup_data.sh` | Backup data and logs | `./scripts/backup_data.sh pre_migration` |
| `scripts/restore_data.sh` | Restore from backup | `./scripts/restore_data.sh backup_20250127` |

### Verification & Debug Scripts

| Script | Description | Verification Step | Example |
|--------|-------------|-------------------|---------|
| `scripts/verify_configs.sh` | Validate all config files | Step 0: Preconditions | `./scripts/verify_configs.sh` |
| `scripts/check_registration_status.sh` | Verify all agents registered | Steps 2-3: Registration | `./scripts/check_registration_status.sh` |
| `scripts/trigger_league_start.sh` | Start league orchestration | Step 4: League Start | `./scripts/trigger_league_start.sh` |
| `scripts/query_standings.sh` | Query current standings | Runtime | `./scripts/query_standings.sh` |
| `scripts/view_match_state.sh` | Inspect match state | Step 5: Match Execution | `./scripts/view_match_state.sh M001 8001` |
| `scripts/analyze_logs.sh` | Filter JSONL logs | All Steps | `./scripts/analyze_logs.sh MESSAGE_SENT` |
| `scripts/cleanup_old_data.sh` | Cleanup old data/logs | Step 8: Cleanup | `./scripts/cleanup_old_data.sh --dry-run` |

### Script Options

All scripts support:
- `--plain` - Plain text output (screen reader compatible)
- `--verbose` - Show detailed information
- `--quiet` - Minimal output (errors only)
- `--help` - Show usage information

Destructive scripts additionally support:
- `--dry-run` - Preview changes without executing
- `--force` - Skip confirmation prompts (use with caution!)

### Example Workflow

```bash
# 1. Verify system is ready
./scripts/verify_configs.sh

# 2. Start all agents
./scripts/start_league.sh

# 3. Check all agents are healthy
./scripts/check_health.sh

# 4. Verify all agents registered
./scripts/check_registration_status.sh

# 5. Trigger league start
./scripts/trigger_league_start.sh

# 6. Monitor standings
./scripts/query_standings.sh

# 7. View specific match state (if needed)
./scripts/view_match_state.sh M001 8001

# 8. Analyze logs
./scripts/analyze_logs.sh MESSAGE_SENT

# 9. Backup data before shutdown
./scripts/backup_data.sh post_league_$(date +%Y%m%d)

# 10. Stop all agents
./scripts/stop_league.sh
```

### For CI/CD and Automation

Use `--plain` and `--quiet` for machine-parseable output:

```bash
# Start league quietly (only errors)
./scripts/start_league.sh --plain --quiet

# Check health with plain output
./scripts/check_health.sh --plain

# Get standings as JSON (future enhancement)
./scripts/query_standings.sh --json > standings.json
```

### Accessibility

All scripts are **WCAG 2.1 compliant** with:
- Plain text mode (no emoji-only information)
- Screen reader compatible output
- Keyboard-only operation
- Clear error messages with recovery suggestions

```bash
# Screen reader mode (no emojis)
./scripts/check_health.sh --plain

# Output:
# [INFO] Checking health of all agents
# [SUCCESS] League Manager is healthy
# [SUCCESS] Referee REF01 is healthy
# ...
```
```

---

### Task 5.2: Update Missions Document

**Update Missions_EvenOddLeague.md:**

```markdown
### M6.1: CLI Argument Parsing ‚úÖ COMPLETED (2025-12-27)
**Priority:** P1 (High)
**Estimated Time:** 1.5 hours (Actual: 1.5 hours)

**Definition of Done:**
- [x] argparse configuration in all 7 agent main.py files
- [x] Common arguments: --log-level, --port, --host, --config
- [x] Agent-specific arguments: --player-id, --referee-id, --league-id
- [x] Output control: --verbose, --quiet, --plain, --json
- [x] --help displays comprehensive usage information
- [x] --version displays agent version
- [x] Validation of required arguments (port range, mutually exclusive flags)
- [x] **ENHANCED:** Accessibility features (--plain mode for screen readers)
- [x] **ENHANCED:** Comprehensive help text with examples, exit codes, error codes

**Completion Evidence:**
- All 7 agents (LM01, REF01, REF02, P01-P04) support full CLI argument parsing
- Help text includes examples, environment variables, exit codes, error codes
- --plain mode ensures screen reader compatibility (WCAG 2.1 compliant)
- Backward compatibility maintained with environment variables
- Priority order: CLI args > Env vars > Config files > Defaults

**Files Modified:**
- agents/league_manager/main.py (enhanced help text)
- agents/referee_REF01/main.py (enhanced help text)
- agents/referee_REF02/main.py (enhanced help text)
- agents/player_P01/main.py (NEW: added argparse)
- agents/player_P02/main.py (NEW: added argparse)
- agents/player_P03/main.py (NEW: added argparse)
- agents/player_P04/main.py (NEW: added argparse)

---

### M6.2: Operational Scripts ‚úÖ COMPLETED (2025-12-27)
**Priority:** P1 (High)
**Estimated Time:** 2 hours (Actual: 2.5 hours with enhancements)

**Definition of Done:**
- [x] scripts/start_league.sh - Launches all agents in correct order
- [x] scripts/stop_league.sh - Graceful shutdown of all agents
- [x] scripts/check_health.sh - Health check all agent endpoints
- [x] scripts/backup_data.sh - Backup data/ and logs/
- [x] scripts/restore_data.sh - Restore from backup
- [x] All scripts executable (chmod +x)
- [x] **ENHANCED:** scripts/lib/common.sh - Shared functions library
- [x] **ENHANCED:** 7 verification scripts aligned with 14-step system integration plan
- [x] **ENHANCED:** Accessibility support (--plain, --verbose, --quiet)
- [x] **ENHANCED:** Error handling with actual error codes (E001-E018)
- [x] **ENHANCED:** --dry-run mode for destructive operations
- [x] **ENHANCED:** Comprehensive help text and recovery suggestions

**Completion Evidence:**
- 12 total operational scripts created and tested
- All scripts include error handling with actual error codes
- All scripts support accessibility flags (--plain for screen readers)
- Scripts map directly to 14-step system integration verification plan
- Common functions library ensures consistency across all scripts
- README.md updated with complete script documentation

**Files Created:**
- scripts/backup_data.sh (NEW: with dry-run, accessibility)
- scripts/restore_data.sh (NEW: with dry-run, accessibility)
- scripts/verify_configs.sh (NEW: Step 0 verification)
- scripts/check_registration_status.sh (NEW: Steps 2-3 verification)
- scripts/trigger_league_start.sh (NEW: Step 4 verification)
- scripts/query_standings.sh (NEW: Runtime tool)
- scripts/view_match_state.sh (NEW: Step 5 debug tool)
- scripts/analyze_logs.sh (NEW: All-steps debug tool)
- scripts/cleanup_old_data.sh (NEW: Step 8 manual trigger)
- scripts/lib/common.sh (NEW: Shared functions library)

**Files Modified:**
- scripts/start_league.sh (UPDATED: enhanced with accessibility, validation)
- scripts/stop_league.sh (UPDATED: enhanced with accessibility)
- scripts/check_health.sh (UPDATED: enhanced with accessibility)

**Test Evidence:**
- tests/manual/test_full_workflow.sh - Integration test passes
- tests/manual/test_accessibility.sh - Accessibility test passes
- tests/manual/test_cli_validation.sh - CLI validation test passes

---

### M6.6: Usability Analysis ‚úÖ COMPLETED (2025-12-27)
**Priority:** P1 (High)
**Estimated Time:** 1.5 hours (Actual: 1 hour)

**Definition of Done:**
- [x] doc/usability_analysis.md created
- [x] CLI design principles analysis (discoverability, consistency, feedback, error prevention)
- [x] Accessibility considerations (screen readers, color contrast, text output)
- [x] Usability heuristics evaluation (Nielsen's 10 heuristics)
- [x] Error message clarity assessment
- [x] doc/error_codes_reference.md created with all 18 error codes
- [x] Recovery suggestions for all error codes

**Completion Evidence:**
- Complete usability analysis documented
- All 18 error codes (E001-E018) documented with recovery suggestions
- Nielsen's 10 heuristics evaluated and scored
- WCAG 2.1 accessibility compliance achieved
- CLI design principles implemented across all agents and scripts

**Files Created:**
- doc/error_codes_reference.md (600+ lines, comprehensive error documentation)
- doc/usability_analysis.md (Phase 5.5 output)
```

---

## PHASE 5.5: USABILITY ANALYSIS (M6.6)

**Estimated Time:** 1 hour
**Priority:** P1

### Task 5.5.1: Create Usability Analysis Document

**File:** `doc/usability_analysis.md`

**Purpose:** Complete usability analysis per M6.6 requirements

**Implementation:** (See next message for full content due to length constraints)

---

## SUCCESS CRITERIA

### Must Pass Before Commit

- [ ] All 4 player agents support full CLI arguments (--help, --version, --player-id, --league-id, --port, --log-level, --verbose, --quiet, --plain, --json)
- [ ] All agents display comprehensive help text with examples and exit codes
- [ ] doc/error_codes_reference.md created with all 18 error codes
- [ ] scripts/lib/common.sh library created with accessibility functions
- [ ] scripts/backup_data.sh and scripts/restore_data.sh work correctly
- [ ] All 7 verification scripts created and tested
- [ ] All scripts support --plain, --verbose, --quiet flags
- [ ] Integration test passes (test_full_workflow.sh)
- [ ] Accessibility test passes (test_accessibility.sh)
- [ ] CLI validation test passes (test_cli_validation.sh)
- [ ] All scripts executable and syntax-validated
- [ ] README.md updated with CLI usage and script documentation
- [ ] Missions document updated with M6.1, M6.2, M6.6 completion
- [ ] doc/usability_analysis.md created

### Quality Gates

- [ ] **Code Quality:** All Python changes pass flake8, black, isort, mypy
- [ ] **Script Quality:** All shell scripts pass `bash -n` syntax check
- [ ] **Functional:** Full league can be started, run, and stopped using new scripts
- [ ] **Accessibility:** All scripts work correctly with --plain flag (no emoji dependencies)
- [ ] **Documentation:** README has clear examples for all scripts and CLI arguments
- [ ] **Error Handling:** All errors use actual error codes (E001-E018) with recovery suggestions
- [ ] **Usability:** Nielsen's heuristics score ‚â•7/10 for each heuristic

---

## ROLLBACK PLAN

If issues arise during implementation:

### Rollback Player CLI Changes
```bash
git checkout agents/player_P01/main.py
git checkout agents/player_P02/main.py
git checkout agents/player_P03/main.py
git checkout agents/player_P04/main.py
```

### Rollback Script Changes
```bash
# Remove new files
rm scripts/lib/common.sh
rm scripts/backup_data.sh
rm scripts/restore_data.sh
rm scripts/verify_configs.sh
rm scripts/check_registration_status.sh
rm scripts/trigger_league_start.sh
rm scripts/query_standings.sh
rm scripts/view_match_state.sh
rm scripts/analyze_logs.sh
rm scripts/cleanup_old_data.sh
rm doc/error_codes_reference.md

# Restore original scripts
git checkout scripts/start_league.sh
git checkout scripts/stop_league.sh
git checkout scripts/check_health.sh
```

---

## IMPLEMENTATION CHECKLIST

### Phase 1: CLI Argument Parsing
- [ ] Task 1.1: Add argparse to Player P01
- [ ] Task 1.2: Add argparse to Player P02
- [ ] Task 1.3: Add argparse to Player P03
- [ ] Task 1.4: Add argparse to Player P04

### Phase 1.5: CLI Best Practices
- [ ] Task 1.5.1: Create error_codes_reference.md
- [ ] Task 1.5.2: Create scripts/lib/common.sh
- [ ] Task 1.5.3: Update existing scripts to use common library

### Phase 2: Core Operational Scripts
- [ ] Task 2.1: Create backup_data.sh
- [ ] Task 2.2: Create restore_data.sh
- [ ] Task 2.3: Update start_league.sh

### Phase 3: Verification Stage Scripts
- [ ] Task 3.1: Create verify_configs.sh
- [ ] Task 3.2: Create check_registration_status.sh
- [ ] Task 3.3: Create trigger_league_start.sh
- [ ] Task 3.4: Create query_standings.sh
- [ ] Task 3.5: Create view_match_state.sh
- [ ] Task 3.6: Create analyze_logs.sh
- [ ] Task 3.7: Create cleanup_old_data.sh

### Phase 4: Testing & Validation
- [ ] Task 4.1: Integration test - Full workflow
- [ ] Task 4.2: Accessibility test
- [ ] Task 4.3: CLI validation test

### Phase 5: Documentation Update
- [ ] Task 5.1: Update README.md
- [ ] Task 5.2: Update Missions document

### Phase 5.5: Usability Analysis
- [ ] Task 5.5.1: Create usability_analysis.md

---

## NEXT STEPS

1. **Review this enhanced plan** with stakeholders
2. **Implement Phase 1** (CLI arguments for players)
3. **Implement Phase 1.5** (Error codes reference + common library)
4. **Implement Phases 2-3** (Operational + verification scripts)
5. **Run full test suite** (Phase 4)
6. **Update documentation** (Phases 5 & 5.5)
7. **Run pre-commit hooks** and commit all changes
8. **Push to repository** and verify CI passes

---

## APPENDIX: FILE SUMMARY

### Files to Create (21 total)

**Documentation (2 files):**
1. `doc/error_codes_reference.md` - Complete error code documentation (~600 lines)
2. `doc/usability_analysis.md` - Usability analysis per M6.6

**Python Changes (4 files):**
3. `agents/player_P01/main.py` - Add enhanced argparse
4. `agents/player_P02/main.py` - Add enhanced argparse
5. `agents/player_P03/main.py` - Add enhanced argparse
6. `agents/player_P04/main.py` - Add enhanced argparse

**Shared Library (1 file):**
7. `scripts/lib/common.sh` - Shared functions for all scripts

**New Scripts (9 files):**
8. `scripts/backup_data.sh`
9. `scripts/restore_data.sh`
10. `scripts/verify_configs.sh`
11. `scripts/check_registration_status.sh`
12. `scripts/trigger_league_start.sh`
13. `scripts/query_standings.sh`
14. `scripts/view_match_state.sh`
15. `scripts/analyze_logs.sh`
16. `scripts/cleanup_old_data.sh`

**Test Files (3 files):**
17. `tests/manual/test_full_workflow.sh`
18. `tests/manual/test_accessibility.sh`
19. `tests/manual/test_cli_validation.sh`

**Documentation Updates (2 files):**
20. `README.md` - Add CLI usage and script documentation
21. `Missions_EvenOddLeague.md` - Mark M6.1, M6.2, M6.6 completed

### Files to Modify (3 existing scripts)

1. `scripts/start_league.sh` - Enhanced with accessibility, validation
2. `scripts/stop_league.sh` - Enhanced with accessibility
3. `scripts/check_health.sh` - Enhanced with accessibility

---

**Estimated Total Implementation Time:** 5 hours
**Compliance:** M6.1 ‚úÖ, M6.2 ‚úÖ, M6.6 ‚úÖ
**Accessibility:** WCAG 2.1 Level AA Compliant
**Usability:** Nielsen's Heuristics ‚â•7/10 each

---

**END OF ENHANCED IMPLEMENTATION PLAN v2.0**
