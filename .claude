# Even/Odd League - Project Context

**Last Updated:** 2025-12-20
**Project Status:** 45% Complete (33/74 missions)
**Current Phase:** Foundation Complete â†’ Agent Implementation Phase

---

## Quick Status Overview

**âœ… WORKING & TESTED:**
- SDK Infrastructure (protocol, config, logging, retry, repositories, cleanup)
- Player Agent P01 (MCP server, 3 tools, registration)
- Data Retention System (automated cleanup, archival, manual scripts)
- Quality Infrastructure (pre-commit, CI/CD, 209 tests @ 85.47% coverage)
- Configuration Layer (system, agents, leagues, games)

**ğŸš§ IN PROGRESS:**
- None currently

**â˜ NEXT PRIORITIES:**
1. Referee Agent (M7.5-M7.8) - Match conductor, timeout enforcement, game logic
2. League Manager (M7.9-M7.14) - Registration, scheduling, standings
3. Integration Tests (M4.2) - Multi-agent workflows

---

## Architecture Overview

### System Design
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         MULTI-AGENT SYSTEM                  â”‚
â”‚                                             â”‚
â”‚  League Manager â†â†’ Referees â†â†’ Players     â”‚
â”‚      (LM01)         (2 refs)    (4 agents) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ All communicate via â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    JSON-RPC 2.0 over HTTP (league.v2)      â”‚
â”‚    Port ranges: LM=8000, Ref=8001-8002,    â”‚
â”‚                 Players=8101-8104           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ Built on â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         SHARED SDK (league_sdk)             â”‚
â”‚  â€¢ Protocol (18 message types, 18 errors)  â”‚
â”‚  â€¢ Config (4 layers: system, agents, etc)  â”‚
â”‚  â€¢ Logging (JSONL structured)              â”‚
â”‚  â€¢ Retry (exponential backoff + circuit)   â”‚
â”‚  â€¢ Repositories (atomic file ops)          â”‚
â”‚  â€¢ Cleanup (6 async functions)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Protocol
- **Spec:** league.v2 (JSON-RPC 2.0 over HTTP)
- **Auth:** 32-char tokens per conversation
- **Messages:** 18 types (GAME_INVITATION, CHOOSE_PARITY_CALL, etc.)
- **Errors:** 18 error codes (E001-E018) with retry classification
- **Timeouts:** 5s (join), 10s (registration), 30s (parity choice)

### Data Architecture (4 Layers)
```
SHARED/
â”œâ”€â”€ config/          # Static JSON configs (versioned)
â”œâ”€â”€ data/            # Runtime data (git-ignored)
â”œâ”€â”€ logs/            # JSONL logs, rotated (git-ignored)
â””â”€â”€ archive/         # Gzipped old data (git-ignored)
```

---

## Key Implementation Details

### Completed Components

**1. SDK (SHARED/league_sdk/)**
- protocol.py (893 lines) - All message types, validation
- config_models.py (458 lines) - Pydantic schemas
- config_loader.py (156 lines) - Load with env overrides
- logger.py (403 lines) - Structured JSONL logging
- retry.py (514 lines) - Retry + circuit breaker
- repositories.py (485 lines) - 4 repos (standings, matches, history, rounds)
- cleanup.py (258 lines) - 6 async cleanup functions
- queue_processor.py (59 lines) - Thread-safe message queue

**2. Player Agent (agents/player_P01/)**
- server.py (177 lines) - MCP server, JSON-RPC dispatch
- handlers.py (132 lines) - 3 tool handlers:
  - GAME_INVITATION â†’ GAME_JOIN_ACK
  - CHOOSE_PARITY_CALL â†’ CHOOSE_PARITY_RESPONSE
  - MATCH_RESULT_REPORT â†’ ack/log
- **Status:** âœ… Working, registered, tested
- **Ports:** P01=8101, P02=8102, P03=8103, P04=8104

**3. Data Retention System**
- doc/data_retention_policy.md (22KB) - Complete spec
- SHARED/scripts/cleanup_data.py (273 lines) - Manual CLI tool
- **Retention:** Logs 30d, Matches 365d, Standings permanent
- **Strategy:** Archive â†’ Gzip (80% reduction) â†’ Delete
- **Safety:** IN_PROGRESS matches never deleted, active logs preserved
- **Schedule:** Daily 2 AM UTC (via League Manager)

**4. Configuration**
- system.json - Global settings (timeouts, retry, data_retention)
- agents_config.json - 7 agents (LM, 2 refs, 4 players)
- league_2025_even_odd.json - League rules, scoring
- games_registry.json - Even/Odd game definition
- **Env Overrides:** 15+ settings via .env

**5. Quality Infrastructure**
- **Tests:** 209 passing (85.47% coverage)
  - test_protocol_models.py (60 tests)
  - test_logger.py (35 tests)
  - test_retry.py (34 tests)
  - test_repositories.py (33 tests)
  - test_cleanup.py (17 tests)
  - test_config_models.py (16 tests)
  - Player/agent tests (14 tests)
- **CI/CD:** GitHub Actions (black, isort, flake8, mypy, pytest)
- **Pre-commit:** 10 hooks enforced
- **Python:** 3.10, 3.11 tested (3.10+ supported)

---

## Critical Design Decisions

### 1. Async/Await Pattern
- All cleanup operations use async/await (non-blocking)
- Player handlers can be sync or async (auto-detected)
- asyncio.wait_for() for timeout enforcement
- **Python 3.10 Fix:** Catch both TimeoutError and asyncio.TimeoutError

### 2. Atomic File Operations
- Pattern: Write to .tmp â†’ rename to actual file
- Ensures data integrity even if process crashes
- Used in all repositories (standings, matches, history, rounds)

### 3. Thread Safety
- Sequential message processing via queue_processor.py
- No shared mutable state between agents
- Each agent has its own logger, config, state
- Cleanup runs in background asyncio task (safe)

### 4. Configuration-Driven
- All retention periods, timeouts, ports in system.json
- No hardcoded values in business logic
- Easy to adjust without code changes

### 5. Structured Logging
- Format: JSON Lines (JSONL) - one JSON object per line
- Rotation: 100MB files, 5 backups
- Organization: Separate dirs for agents, league, system
- Fields: timestamp, level, agent_id, event_type, conversation_id

---

## Project Structure (Key Locations)

```
LLM_Agent_Orchestration_HW7/
â”œâ”€â”€ .claude                      # THIS FILE - Project context
â”œâ”€â”€ PRD_EvenOddLeague.md        # Requirements (102KB, 17 sections)
â”œâ”€â”€ Missions_EvenOddLeague.md   # 74 missions, DoD, verify commands
â”œâ”€â”€ PROGRESS_TRACKER.md         # Status, 33/74 complete (45%)
â”œâ”€â”€ README.md                   # Usage guide, architecture
â”‚
â”œâ”€â”€ SHARED/
â”‚   â”œâ”€â”€ league_sdk/             # SDK (pip install -e)
â”‚   â”œâ”€â”€ config/                 # JSON configs (4 types)
â”‚   â”œâ”€â”€ data/                   # Runtime (git-ignored)
â”‚   â”œâ”€â”€ logs/                   # JSONL logs (git-ignored)
â”‚   â”œâ”€â”€ archive/                # Gzipped archives (git-ignored)
â”‚   â””â”€â”€ scripts/
â”‚       â””â”€â”€ cleanup_data.py     # Manual cleanup tool
â”‚
â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â””â”€â”€ agent_base.py       # BaseAgent class (shared)
â”‚   â”œâ”€â”€ player_P01/             # âœ… WORKING
â”‚   â”‚   â”œâ”€â”€ server.py
â”‚   â”‚   â”œâ”€â”€ handlers.py
â”‚   â”‚   â””â”€â”€ main.py
â”‚   â”œâ”€â”€ player_P02-P04/         # Reuse P01 implementation
â”‚   â”œâ”€â”€ referee_REF01/          # â˜ TODO: M7.5-M7.8
â”‚   â”œâ”€â”€ referee_REF02/          # â˜ TODO
â”‚   â””â”€â”€ league_manager/         # â˜ TODO: M7.9-M7.14
â”‚
â”œâ”€â”€ tests/                      # 209 tests, 85.47% coverage
â”‚   â”œâ”€â”€ unit/test_sdk/
â”‚   â”œâ”€â”€ unit/test_agents/
â”‚   â””â”€â”€ integration/
â”‚
â”œâ”€â”€ doc/
â”‚   â”œâ”€â”€ data_retention_policy.md
â”‚   â”œâ”€â”€ game_rules/even_odd.md
â”‚   â”œâ”€â”€ algorithms/round_robin.md
â”‚   â””â”€â”€ research_notes/mcp_protocol.md
â”‚
â””â”€â”€ .github/workflows/
    â””â”€â”€ test.yml                # CI/CD quality gates
```

---

## Next Steps (Priority Order)

### Immediate: Referee Agent (M7.5-M7.8) - 10.5 hours
**Priority:** P0 (Critical for QG-2)
**Blocks:** Integration tests, end-to-end workflows

1. **M7.5:** Match Conductor (5h)
   - Invite both players (GAME_INVITATION)
   - Wait for acks with timeout
   - Handle player no-shows (E007)

2. **M7.6:** Timeout Enforcement (2h)
   - Track deadlines per message type
   - Cancel slow operations
   - Return E001 (timeout) errors

3. **M7.7:** Even/Odd Game Logic (2h)
   - Request parity choices from players
   - Draw random number (1-10)
   - Determine winner: choice matches parity
   - Handle draws (both choose same)

4. **M7.8:** Registration & Setup (1.5h)
   - Register with League Manager
   - Receive auth token
   - Store configuration
   - Health check endpoint

**Files to Create:**
- agents/referee_REF01/server.py (~400 lines)
- agents/referee_REF01/match_conductor.py (~250 lines)
- agents/referee_REF01/game_logic.py (~150 lines)
- agents/referee_REF01/handlers.py (~100 lines)
- tests/unit/test_referee.py (~300 lines)

### After Referee: League Manager (M7.9-M7.14) - 16 hours
**Priority:** P0 (Critical for QG-4)

1. Player registration (accept/reject)
2. Round-robin scheduling (n*(n-1)/2 matches)
3. Assign referees to matches
4. Update standings after each match
5. Track league state (REGISTRATION â†’ IN_PROGRESS â†’ COMPLETED)
6. Persist rounds, standings, player roster

### Then: Integration Tests (M4.2) - 4 hours
- Multi-agent workflows
- Full match lifecycle
- Error recovery scenarios
- Concurrent match handling

---

## Common Tasks & Commands

### Development
```bash
# Install SDK (editable mode)
pip install -e SHARED/league_sdk

# Run all tests
PYTHONPATH=SHARED:$PYTHONPATH pytest tests/ -v

# Run with coverage
PYTHONPATH=SHARED:$PYTHONPATH pytest tests/ \
  --cov=SHARED/league_sdk --cov=agents --cov-fail-under=85

# Run specific test file
PYTHONPATH=SHARED:$PYTHONPATH pytest tests/unit/test_sdk/test_cleanup.py -v

# Start player agent
cd agents/player_P01
PYTHONPATH=../../SHARED:$PYTHONPATH python main.py
```

### Quality Checks
```bash
# Format code
black agents SHARED tests

# Sort imports
isort agents SHARED tests

# Lint
flake8 agents SHARED tests

# Type check
mypy agents SHARED --config-file=mypy.ini

# All pre-commit hooks
pre-commit run --all-files
```

### Data Retention
```bash
# Manual cleanup (dry-run)
python SHARED/scripts/cleanup_data.py --dry-run

# Execute cleanup
python SHARED/scripts/cleanup_data.py --execute

# Cleanup specific type
python SHARED/scripts/cleanup_data.py --execute --type logs
```

### Git Workflow
```bash
# Commit with conventional commits
git commit -m "feat: description"    # New feature
git commit -m "fix: description"     # Bug fix
git commit -m "docs: description"    # Documentation

# Push (triggers CI/CD)
git push origin main

# View recent workflow runs
gh run list --limit 5
```

---

## Mission Tracking

### Completed Missions (33/74 = 45%)

**M0: Kickoff (3/3)** âœ…
**M1: Requirements (5/5)** âœ…
**M2: Setup & Architecture (6/7)** âœ…
**M3: Configuration (7/7)** âœ…
**M4: Testing (2/6)** ğŸš§
**M5: Research (4/4)** âœ…
**M6: UX/DevEx (4/9)** ğŸš§
**M7: Agent Implementation (2/18)** ğŸš§
**M8: Documentation (0/9)** â˜
**M9: Submission (0/4)** â˜

---

## Quality Metrics

| Metric | Current | Target | Status |
|--------|---------|--------|--------|
| Missions Complete | 33/74 | 74 | 45% |
| Test Coverage | 85.47% | â‰¥85% | âœ… |
| Tests Passing | 209/209 | 100% | âœ… |
| Protocol Messages | 18/18 | 18 | âœ… |
| Error Codes | 18/18 | 18 | âœ… |
| Agents Complete | 1/7 | 7 | 14% |
| Python Support | 3.10, 3.11 | 3.10+ | âœ… |

---

## Important Conventions

### Code Style
- **Formatting:** Black (104 char line length)
- **Imports:** isort (black profile)
- **Type Hints:** Required for public APIs
- **Docstrings:** Required for modules, classes, public functions

### Commit Messages
- **Format:** Conventional Commits (feat:, fix:, docs:, etc.)

### Testing
- **Coverage:** Must maintain â‰¥85%
- **Markers:** @pytest.mark.unit, @pytest.mark.integration
- **Naming:** test_<function>_<scenario>_<expected>

---

## Quick Reference

### Port Assignments
- League Manager: 8000
- Referee 01: 8001
- Referee 02: 8002
- Players: 8101-8104

### Timeout Values
- Registration: 10s
- Game join ack: 5s
- Parity choice: 30s

### Retention Periods
- Logs: 30 days
- Matches: 365 days
- Player history: 365 days
- Standings: Permanent

### Error Codes (Retryable)
E001, E005, E006, E009, E014, E015, E016

---

## Session Start Checklist

1. **Context:** Read this .claude file
2. **Status:** 45% complete, next: Referee Agent (M7.5-M7.8)
3. **Environment:** source venv/bin/activate
4. **Tests:** pytest tests/ --co -q (should show 209 items)
5. **Git:** git status (should be clean)
6. **CI/CD:** gh run list --limit 1 (should show passing)

---

**Version:** 1.0.0
**Last Mission Completed:** M3.7 (Data Retention Policy)
**Next Mission:** M7.5 (Referee Agent - Match Conductor)
