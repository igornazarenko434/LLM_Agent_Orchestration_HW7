# Even/Odd League - Project Context

**Last Updated:** 2025-12-23
**Project Status:** 50% Complete (37/74 missions)
**Current Phase:** Foundation Complete â†’ Agent Implementation Phase

---

## Quick Status Overview

**âœ… WORKING & TESTED:**
- SDK Infrastructure (protocol, config, logging, retry, repositories, cleanup)
- Player Agent P01 (MCP server, 3 tools, registration)
- **Referee Agent REF01 (Match conductor, timeout enforcement, game logic, registration)** âœ¨ NEW
- Data Retention System (automated cleanup, archival, manual scripts)
- Quality Infrastructure (pre-commit, CI/CD, 256 tests @ 76% coverage)
- Configuration Layer (system, agents, leagues, games)

**ğŸš§ IN PROGRESS:**
- None currently

**â˜ NEXT PRIORITIES:**
1. **M7.9.1:** Async HTTP Client Migration (CRITICAL - 2-3h) - Replace requests with httpx
2. **M7.9:** League Manager Registration (3h) - Accept player/referee registrations
3. **M7.10-M7.14:** League Manager Core (13h) - Scheduling, standings, orchestration
4. Integration Tests (M4.2) - Multi-agent workflows

---

## Architecture Overview

### System Design
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         MULTI-AGENT SYSTEM                  â”‚
â”‚                                             â”‚
â”‚  League Manager â†â†’ Referees â†â†’ Players     â”‚
â”‚      (LM01)         (2 refs)    (4 agents) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ All communicate via â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    JSON-RPC 2.0 over HTTP (league.v2)      â”‚
â”‚    Port ranges: LM=8000, Ref=8001-8002,    â”‚
â”‚                 Players=8101-8104           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ Built on â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         SHARED SDK (league_sdk)             â”‚
â”‚  â€¢ Protocol (18 message types, 18 errors)  â”‚
â”‚  â€¢ Config (4 layers: system, agents, etc)  â”‚
â”‚  â€¢ Logging (JSONL structured)              â”‚
â”‚  â€¢ Retry (exponential backoff + circuit)   â”‚
â”‚  â€¢ Repositories (atomic file ops)          â”‚
â”‚  â€¢ Cleanup (6 async functions)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Protocol
- **Spec:** league.v2 (JSON-RPC 2.0 over HTTP)
- **Auth:** 32-char tokens per conversation
- **Messages:** 18 types (GAME_INVITATION, CHOOSE_PARITY_CALL, etc.)
- **Errors:** 18 error codes (E001-E018) with retry classification
- **Timeouts:** 5s (join), 10s (registration), 30s (parity choice)

### Data Architecture (4 Layers)
```
SHARED/
â”œâ”€â”€ config/          # Static JSON configs (versioned)
â”œâ”€â”€ data/            # Runtime data (git-ignored)
â”œâ”€â”€ logs/            # JSONL logs, rotated (git-ignored)
â””â”€â”€ archive/         # Gzipped old data (git-ignored)
```

---

## Key Implementation Details

### Completed Components

**1. SDK (SHARED/league_sdk/)**
- protocol.py (893 lines) - All message types, validation
- config_models.py (458 lines) - Pydantic schemas
- config_loader.py (156 lines) - Load with env overrides
- logger.py (403 lines) - Structured JSONL logging
- retry.py (514 lines) - Retry + circuit breaker
- repositories.py (485 lines) - 4 repos (standings, matches, history, rounds)
- cleanup.py (258 lines) - 6 async cleanup functions
- queue_processor.py (59 lines) - Thread-safe message queue

**2. Player Agent (agents/player_P01/)**
- server.py (177 lines) - MCP server, JSON-RPC dispatch
- handlers.py (132 lines) - 3 tool handlers:
  - GAME_INVITATION â†’ GAME_JOIN_ACK
  - CHOOSE_PARITY_CALL â†’ CHOOSE_PARITY_RESPONSE
  - MATCH_RESULT_REPORT â†’ ack/log
- **Status:** âœ… Working, registered, tested
- **Ports:** P01=8101, P02=8102, P03=8103, P04=8104

**3. Referee Agent (agents/referee_REF01/)** âœ¨ NEW
- server.py (364 lines) - MCP server, registration, START_MATCH handler
- match_conductor.py (173 lines) - Complete 6-step + post-match protocol
- game_logic.py (173 lines) - Even/Odd winner determination, cryptographic RNG
- timeout_enforcement.py (55 lines) - GAME_ERROR (E001) sending, exponential backoff
- **Status:** âœ… Working, all components tested (47 tests passing)
- **Capabilities:** conduct_match, enforce_timeouts, determine_winner, report_results
- **Coverage:** 98% (game_logic), 98% (timeout_enforcement), 40% (server)
- **Port:** REF01=8001

**4. Data Retention System**
- doc/data_retention_policy.md (22KB) - Complete spec
- SHARED/scripts/cleanup_data.py (273 lines) - Manual CLI tool
- **Retention:** Logs 30d, Matches 365d, Standings permanent
- **Strategy:** Archive â†’ Gzip (80% reduction) â†’ Delete
- **Safety:** IN_PROGRESS matches never deleted, active logs preserved
- **Schedule:** Daily 2 AM UTC (via League Manager)

**5. Configuration**
- system.json - Global settings (timeouts, retry, data_retention)
- agents_config.json - 7 agents (LM, 2 refs, 4 players)
- league_2025_even_odd.json - League rules, scoring
- games_registry.json - Even/Odd game definition
- **Env Overrides:** 15+ settings via .env

**6. Quality Infrastructure**
- **Tests:** 256 passing (76% coverage)
  - test_protocol_models.py (60 tests)
  - test_logger.py (35 tests)
  - test_retry.py (34 tests)
  - test_repositories.py (33 tests)
  - test_game_logic.py (22 tests) âœ¨ NEW
  - test_cleanup.py (17 tests)
  - test_config_models.py (16 tests)
  - test_referee_server.py (13 tests) âœ¨ NEW
  - test_timeout_enforcement.py (12 tests) âœ¨ NEW
  - Player/agent tests (14 tests)
- **CI/CD:** GitHub Actions (black, isort, flake8, mypy, pytest)
- **Pre-commit:** 10 hooks enforced
- **Python:** 3.10, 3.11 tested (3.10+ supported)

---

## Critical Design Decisions

### 1. Async/Await Pattern
- All cleanup operations use async/await (non-blocking)
- Player handlers can be sync or async (auto-detected)
- asyncio.wait_for() for timeout enforcement
- **Python 3.10 Fix:** Catch both TimeoutError and asyncio.TimeoutError

### 2. Atomic File Operations
- Pattern: Write to .tmp â†’ rename to actual file
- Ensures data integrity even if process crashes
- Used in all repositories (standings, matches, history, rounds)

### 3. Thread Safety
- Sequential message processing via queue_processor.py
- No shared mutable state between agents
- Each agent has its own logger, config, state
- Cleanup runs in background asyncio task (safe)

### 4. Configuration-Driven
- All retention periods, timeouts, ports in system.json
- No hardcoded values in business logic
- Easy to adjust without code changes

### 5. Structured Logging
- Format: JSON Lines (JSONL) - one JSON object per line
- Rotation: 100MB files, 5 backups
- Organization: Separate dirs for agents, league, system
- Fields: timestamp, level, agent_id, event_type, conversation_id

---

## Project Structure (Key Locations)

```
LLM_Agent_Orchestration_HW7/
â”œâ”€â”€ .claude                      # THIS FILE - Project context
â”œâ”€â”€ PRD_EvenOddLeague.md        # Requirements (102KB, 17 sections)
â”œâ”€â”€ Missions_EvenOddLeague.md   # 74 missions, DoD, verify commands
â”œâ”€â”€ PROGRESS_TRACKER.md         # Status, 33/74 complete (45%)
â”œâ”€â”€ README.md                   # Usage guide, architecture
â”‚
â”œâ”€â”€ SHARED/
â”‚   â”œâ”€â”€ league_sdk/             # SDK (pip install -e)
â”‚   â”œâ”€â”€ config/                 # JSON configs (4 types)
â”‚   â”œâ”€â”€ data/                   # Runtime (git-ignored)
â”‚   â”œâ”€â”€ logs/                   # JSONL logs (git-ignored)
â”‚   â”œâ”€â”€ archive/                # Gzipped archives (git-ignored)
â”‚   â””â”€â”€ scripts/
â”‚       â””â”€â”€ cleanup_data.py     # Manual cleanup tool
â”‚
â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â””â”€â”€ agent_base.py       # BaseAgent class (shared)
â”‚   â”œâ”€â”€ player_P01/             # âœ… WORKING
â”‚   â”‚   â”œâ”€â”€ server.py
â”‚   â”‚   â”œâ”€â”€ handlers.py
â”‚   â”‚   â””â”€â”€ main.py
â”‚   â”œâ”€â”€ player_P02-P04/         # Reuse P01 implementation
â”‚   â”œâ”€â”€ referee_REF01/          # âœ… COMPLETED: M7.5-M7.8
â”‚   â”‚   â”œâ”€â”€ server.py           # MCP server + registration
â”‚   â”‚   â”œâ”€â”€ match_conductor.py  # 6-step + post-match protocol
â”‚   â”‚   â”œâ”€â”€ game_logic.py       # Even/Odd winner determination
â”‚   â”‚   â”œâ”€â”€ timeout_enforcement.py  # E001 errors + retry
â”‚   â”‚   â””â”€â”€ main.py
â”‚   â”œâ”€â”€ referee_REF02/          # â˜ TODO (can reuse REF01)
â”‚   â””â”€â”€ league_manager/         # â˜ TODO: M7.9-M7.14
â”‚
â”œâ”€â”€ tests/                      # 256 tests, 76% coverage
â”‚   â”œâ”€â”€ unit/test_sdk/
â”‚   â”œâ”€â”€ unit/test_referee_agent/  # âœ¨ NEW (47 tests)
â”‚   â”œâ”€â”€ unit/test_agents/
â”‚   â””â”€â”€ integration/
â”‚
â”œâ”€â”€ doc/
â”‚   â”œâ”€â”€ data_retention_policy.md
â”‚   â”œâ”€â”€ game_rules/even_odd.md
â”‚   â”œâ”€â”€ algorithms/round_robin.md
â”‚   â””â”€â”€ research_notes/mcp_protocol.md
â”‚
â””â”€â”€ .github/workflows/
    â””â”€â”€ test.yml                # CI/CD quality gates
```

---

## Next Steps (Priority Order)

### CRITICAL: Async HTTP Client Migration (M7.9.1) - 2-3 hours
**Priority:** P0 (BLOCKING - Must complete before M7.9)
**Reason:** Current synchronous `requests.post()` blocks event loop for 50+ concurrent matches

**Tasks:**
1. Install `httpx`: `pip install httpx`
2. Update `league_sdk/retry.py::call_with_retry()` to async
3. Update all callers to use `await call_with_retry(...)`
4. Verify non-blocking: 50 concurrent matches in <60s (not 1500s)
5. All 256 tests must still pass

**Impact:** Without this, referee cannot handle concurrent matches without deadlock

---

### Immediate: League Manager Core (M7.9-M7.14) - 16 hours
**Priority:** P0 (Critical for QG-4)
**Blocks:** Integration tests, end-to-end workflows

**Completed:** âœ… M7.5-M7.8 Referee Agent (10.5h)
- âœ… Match Conductor - Complete 6-step protocol
- âœ… Timeout Enforcement - E001 errors + exponential backoff
- âœ… Even/Odd Game Logic - Cryptographic RNG, winner determination
- âœ… Registration & Setup - MCP server, state machine

**Files Created:**
- âœ… agents/referee_REF01/server.py (364 lines)
- âœ… agents/referee_REF01/match_conductor.py (173 lines)
- âœ… agents/referee_REF01/game_logic.py (173 lines)
- âœ… agents/referee_REF01/timeout_enforcement.py (55 lines)
- âœ… tests/unit/test_referee_agent/ (47 tests, 3 files)

**League Manager Tasks:**
1. **M7.9:** Registration Handler (3h)
   - Accept player/referee registrations
   - Generate agent IDs and auth tokens
   - Validate duplicates (E017)

2. **M7.10:** Round-Robin Scheduler (3h)
   - Generate n*(n-1)/2 matches
   - Distribute across rounds
   - Assign referees evenly

3. **M7.11:** Standings Calculator (3h)
   - Update after each match (WIN=3, DRAW=1, LOSS=0)
   - Sort by points, then wins
   - Broadcast updates

4. **M7.12:** Match Result Handler (2h)
   - Receive MATCH_RESULT_REPORT from referees
   - Update standings
   - Track round completion

5. **M7.13:** League Orchestration (3h)
   - State: REGISTRATION â†’ IN_PROGRESS â†’ COMPLETED
   - Round announcements (ROUND_ANNOUNCEMENT)
   - League completion (LEAGUE_COMPLETED)

6. **M7.14:** Full System Integration (2h)
   - End-to-end: 4 players, 2 referees, LM
   - 6 matches across 3 rounds
   - Champion announcement

### Then: Integration Tests (M4.2) - 4 hours
- Multi-agent workflows
- Full match lifecycle
- Error recovery scenarios
- Concurrent match handling

---

## Common Tasks & Commands

### Development
```bash
# Install SDK (editable mode)
pip install -e SHARED/league_sdk

# Run all tests
PYTHONPATH=SHARED:$PYTHONPATH pytest tests/ -v

# Run with coverage
PYTHONPATH=SHARED:$PYTHONPATH pytest tests/ \
  --cov=SHARED/league_sdk --cov=agents --cov-fail-under=85

# Run specific test file
PYTHONPATH=SHARED:$PYTHONPATH pytest tests/unit/test_sdk/test_cleanup.py -v

# Start player agent
cd agents/player_P01
PYTHONPATH=../../SHARED:$PYTHONPATH python main.py
```

### Quality Checks
```bash
# Format code
black agents SHARED tests

# Sort imports
isort agents SHARED tests

# Lint
flake8 agents SHARED tests

# Type check
mypy agents SHARED --config-file=mypy.ini

# All pre-commit hooks
pre-commit run --all-files
```

### Data Retention
```bash
# Manual cleanup (dry-run)
python SHARED/scripts/cleanup_data.py --dry-run

# Execute cleanup
python SHARED/scripts/cleanup_data.py --execute

# Cleanup specific type
python SHARED/scripts/cleanup_data.py --execute --type logs
```

### Git Workflow
```bash
# Commit with conventional commits
git commit -m "feat: description"    # New feature
git commit -m "fix: description"     # Bug fix
git commit -m "docs: description"    # Documentation

# Push (triggers CI/CD)
git push origin main

# View recent workflow runs
gh run list --limit 5
```

---

## Mission Tracking

### Completed Missions (37/74 = 50%)

**M0: Kickoff (3/3)** âœ…
**M1: Requirements (5/5)** âœ…
**M2: Setup & Architecture (6/7)** âœ…
**M3: Configuration (7/7)** âœ…
**M4: Testing (2/6)** ğŸš§
**M5: Research (4/4)** âœ…
**M6: UX/DevEx (4/9)** ğŸš§
**M7: Agent Implementation (6/18)** ğŸš§
  - âœ… M7.1: Agent Base Class
  - âœ… M7.3: Player Agent (handlers + server)
  - âœ… M7.5: Referee Match Conductor âœ¨ NEW
  - âœ… M7.6: Referee Timeout Enforcement âœ¨ NEW
  - âœ… M7.7: Even/Odd Game Logic âœ¨ NEW
  - âœ… M7.8: Referee Registration âœ¨ NEW
  - â˜ M7.9.1: Async HTTP Migration (NEXT - CRITICAL)
  - â˜ M7.9-M7.14: League Manager
**M8: Documentation (0/9)** â˜
**M9: Submission (0/4)** â˜

---

## Quality Metrics

| Metric | Current | Target | Status |
|--------|---------|--------|--------|
| Missions Complete | 37/74 | 74 | 50% ğŸ‰ |
| Test Coverage | 76% | â‰¥85% | âš ï¸ (will improve with LM tests) |
| Tests Passing | 256/256 | 100% | âœ… |
| Protocol Messages | 18/18 | 18 | âœ… |
| Error Codes | 18/18 | 18 | âœ… |
| Agents Complete | 2/7 | 7 | 29% (Player + Referee) |
| Python Support | 3.10, 3.11 | 3.10+ | âœ… |

---

## Important Conventions

### Code Style
- **Formatting:** Black (104 char line length)
- **Imports:** isort (black profile)
- **Type Hints:** Required for public APIs
- **Docstrings:** Required for modules, classes, public functions

### Commit Messages
- **Format:** Conventional Commits (feat:, fix:, docs:, etc.)

### Testing
- **Coverage:** Must maintain â‰¥85%
- **Markers:** @pytest.mark.unit, @pytest.mark.integration
- **Naming:** test_<function>_<scenario>_<expected>

---

## Quick Reference

### Port Assignments
- League Manager: 8000
- Referee 01: 8001
- Referee 02: 8002
- Players: 8101-8104

### Timeout Values
- Registration: 10s
- Game join ack: 5s
- Parity choice: 30s

### Retention Periods
- Logs: 30 days
- Matches: 365 days
- Player history: 365 days
- Standings: Permanent

### Error Codes (Retryable)
E001, E005, E006, E009, E014, E015, E016

---

## Session Start Checklist

1. **Context:** Read this .claude file
2. **Status:** 50% complete (ğŸ‰ HALFWAY!), next: M7.9.1 (Async HTTP - CRITICAL)
3. **Environment:** source venv/bin/activate
4. **Tests:** pytest tests/ --co -q (should show 256 items)
5. **Git:** git status (should be clean)
6. **CI/CD:** gh run list --limit 1 (should show passing)

---

**Version:** 1.1.0
**Last Mission Completed:** M7.8 (Referee Registration & Setup)
**Next Mission:** M7.9.1 (Async HTTP Client Migration) - **CRITICAL PREREQUISITE**
